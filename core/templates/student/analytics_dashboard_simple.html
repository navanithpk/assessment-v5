{% extends 'student/student_base.html' %}

{% block title %}Performance Analytics{% endblock %}

{% block content %}
<style>
/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.a-wrap { max-width: 1100px; margin: 0 auto; }

.a-header {
  display: flex; justify-content: space-between; align-items: center;
  flex-wrap: wrap; gap: 12px; margin-bottom: 20px;
}
.a-header h1 { font-size: 22px; font-weight: 700; color: #111827; margin: 0; }

.range-pills { display: flex; gap: 4px; }
.range-pills a {
  padding: 6px 14px; border-radius: 6px; font-size: 13px; font-weight: 500;
  text-decoration: none; color: #6b7280; border: 1px solid #e5e7eb;
  transition: all .15s;
}
.range-pills a:hover { background: #f3f4f6; }
.range-pills a.on { background: #2563eb; color: white; border-color: #2563eb; }

/* ‚îÄ‚îÄ Top Row: Competence + Metrics ‚îÄ‚îÄ */
.top-row { display: grid; grid-template-columns: 280px 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 768px) { .top-row { grid-template-columns: 1fr; } }

.comp-card {
  background: white; border-radius: 12px; padding: 20px; text-align: center;
  box-shadow: 0 1px 4px rgba(0,0,0,.06); position: relative; overflow: hidden;
}
.comp-level { font-size: 28px; font-weight: 800; margin: 6px 0 2px; }
.comp-score { font-size: 13px; color: #6b7280; }
.comp-trend { font-size: 12px; margin-top: 8px; padding: 4px 10px; border-radius: 20px; display: inline-block; font-weight: 600; }

.comp-excellent { color: #059669; }
.comp-good { color: #2563eb; }
.comp-moderate { color: #d97706; }
.comp-needs { color: #ea580c; }
.comp-risk { color: #dc2626; }

.bg-excellent { background: #ecfdf5; border: 1px solid #a7f3d0; }
.bg-good { background: #eff6ff; border: 1px solid #bfdbfe; }
.bg-moderate { background: #fffbeb; border: 1px solid #fde68a; }
.bg-needs { background: #fff7ed; border: 1px solid #fed7aa; }
.bg-risk { background: #fef2f2; border: 1px solid #fecaca; }

.trend-up { background: #ecfdf5; color: #059669; }
.trend-down { background: #fef2f2; color: #dc2626; }
.trend-flat { background: #f3f4f6; color: #6b7280; }

.metrics-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.m-card {
  background: white; border-radius: 12px; padding: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.m-card .m-icon { font-size: 20px; margin-bottom: 6px; }
.m-card .m-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
.m-card .m-val { font-size: 24px; font-weight: 700; color: #111827; }

/* ‚îÄ‚îÄ Two-column mid ‚îÄ‚îÄ */
.mid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
@media (max-width: 768px) { .mid-row { grid-template-columns: 1fr; } }

.card {
  background: white; border-radius: 12px; padding: 18px;
  box-shadow: 0 1px 4px rgba(0,0,0,.06);
}
.card h2 { font-size: 15px; font-weight: 700; color: #374151; margin: 0 0 12px; }

/* Subject bars */
.subj-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.subj-name { width: 90px; font-size: 13px; font-weight: 500; color: #374151; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subj-bar-bg { flex: 1; height: 22px; background: #f3f4f6; border-radius: 6px; overflow: hidden; position: relative; }
.subj-bar { height: 100%; border-radius: 6px; transition: width .4s; min-width: 2px; }
.subj-pct { width: 44px; font-size: 13px; font-weight: 700; color: #374151; }
.bar-green { background: linear-gradient(90deg, #10b981, #34d399); }
.bar-blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.bar-yellow { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.bar-red { background: linear-gradient(90deg, #ef4444, #f87171); }

/* Strengths / Weaknesses pills */
.sw-list { display: flex; flex-direction: column; gap: 8px; }
.sw-item {
  display: flex; align-items: center; gap: 10px; padding: 8px 12px;
  border-radius: 8px; font-size: 13px;
}
.sw-item .sw-name { flex: 1; font-weight: 500; color: #111827; }
.sw-item .sw-score { font-weight: 700; font-size: 14px; }
.sw-strength { background: #ecfdf5; }
.sw-strength .sw-score { color: #059669; }
.sw-weakness { background: #fef2f2; }
.sw-weakness .sw-score { color: #dc2626; }

/* ‚îÄ‚îÄ Timeline chart ‚îÄ‚îÄ */
.chart-card { margin-bottom: 16px; }
.chart-area { position: relative; height: 160px; }
canvas { width: 100% !important; height: 100% !important; }

/* ‚îÄ‚îÄ Recent tests table ‚îÄ‚îÄ */
.t-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.t-table th { text-align: left; font-weight: 600; color: #6b7280; padding: 8px 10px; border-bottom: 2px solid #e5e7eb; font-size: 12px; text-transform: uppercase; letter-spacing: .3px; }
.t-table td { padding: 10px; border-bottom: 1px solid #f3f4f6; color: #374151; }
.t-table tr:last-child td { border-bottom: none; }
.score-badge {
  display: inline-block; padding: 3px 10px; border-radius: 20px;
  font-weight: 700; font-size: 12px;
}
.sb-green { background: #ecfdf5; color: #059669; }
.sb-blue { background: #eff6ff; color: #2563eb; }
.sb-yellow { background: #fffbeb; color: #d97706; }
.sb-red { background: #fef2f2; color: #dc2626; }

/* Empty */
.empty-box { text-align: center; padding: 40px 20px; color: #9ca3af; }
.empty-box .em-icon { font-size: 48px; margin-bottom: 8px; opacity: .4; }
</style>

<div class="a-wrap">

  <!-- Header -->
  <div class="a-header">
    <h1>üìä My Performance</h1>
    <div class="range-pills">
      <a href="?range=1m" class="{% if time_range == '1m' %}on{% endif %}">1M</a>
      <a href="?range=3m" class="{% if time_range == '3m' %}on{% endif %}">3M</a>
      <a href="?range=6m" class="{% if time_range == '6m' %}on{% endif %}">6M</a>
      <a href="?range=1y" class="{% if time_range == '1y' %}on{% endif %}">1Y</a>
    </div>
  </div>

  {% if total_tests > 0 %}

  <!-- Top Row: Competence + 3 Metric cards -->
  <div class="top-row">
    <div class="comp-card {% if competence.level == 'Excellent' %}bg-excellent{% elif competence.level == 'Good' %}bg-good{% elif competence.level == 'Moderate' %}bg-moderate{% elif competence.level == 'Needs Improvement' %}bg-needs{% else %}bg-risk{% endif %}">
      <div style="font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: .5px;">Overall Competence</div>
      <div class="comp-level {% if competence.level == 'Excellent' %}comp-excellent{% elif competence.level == 'Good' %}comp-good{% elif competence.level == 'Moderate' %}comp-moderate{% elif competence.level == 'Needs Improvement' %}comp-needs{% else %}comp-risk{% endif %}">
        {{ competence.level }}
      </div>
      <div class="comp-score">Composite: {{ competence.score }}%</div>
      {% if competence.trend %}
      <span class="comp-trend {% if competence.trend == 'Improving' %}trend-up{% elif competence.trend == 'Declining' %}trend-down{% else %}trend-flat{% endif %}">
        {% if competence.trend == 'Improving' %}‚Üë{% elif competence.trend == 'Declining' %}‚Üì{% else %}‚Üí{% endif %}
        {{ competence.trend }}
        {% if competence.trend_diff %}({{ competence.trend_diff|floatformat:1 }}%){% endif %}
      </span>
      {% endif %}
    </div>

    <div>
      <div class="metrics-row">
        <div class="m-card">
          <div class="m-icon">üìù</div>
          <div class="m-label">Tests Taken</div>
          <div class="m-val">{{ total_tests }}</div>
        </div>
        <div class="m-card">
          <div class="m-icon">üìà</div>
          <div class="m-label">Average Score</div>
          <div class="m-val">{{ average_score }}%</div>
        </div>
        <div class="m-card">
          <div class="m-icon">‚ùì</div>
          <div class="m-label">Questions</div>
          <div class="m-val">{{ total_questions }}</div>
        </div>
      </div>

      <!-- Mini score timeline (inline SVG) -->
      {% if timeline|length >= 2 %}
      <div class="card" style="margin-top: 12px; padding: 12px 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <span style="font-size: 12px; font-weight: 600; color: #6b7280;">Score Trend</span>
          <span style="font-size: 11px; color: #9ca3af;">{{ timeline|length }} tests</span>
        </div>
        <svg id="trendSvg" viewBox="0 0 400 60" style="width: 100%; height: 60px;" preserveAspectRatio="none">
          <!-- Filled via JS -->
        </svg>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Mid Row: Subjects + Strengths/Weaknesses -->
  <div class="mid-row">
    <!-- Subject Performance -->
    <div class="card">
      <h2>Subject Performance</h2>
      {% for s in subject_performance %}
      <div class="subj-row">
        <div class="subj-name" title="{{ s.name }}">{{ s.name }}</div>
        <div class="subj-bar-bg">
          <div class="subj-bar {% if s.score >= 80 %}bar-green{% elif s.score >= 60 %}bar-blue{% elif s.score >= 40 %}bar-yellow{% else %}bar-red{% endif %}"
               style="width: {{ s.score }}%;"></div>
        </div>
        <div class="subj-pct">{{ s.score }}%</div>
      </div>
      {% empty %}
      <p style="color: #9ca3af; font-size: 13px;">No subject data yet</p>
      {% endfor %}
    </div>

    <!-- Strengths & Weaknesses -->
    <div class="card">
      <h2>Strengths & Weaknesses</h2>
      {% if strengths %}
      <div style="font-size: 11px; font-weight: 600; color: #059669; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px;">üí™ Strongest Topics</div>
      <div class="sw-list" style="margin-bottom: 14px;">
        {% for s in strengths %}
        <div class="sw-item sw-strength">
          <span class="sw-name">{{ s.name }}</span>
          <span class="sw-score">{{ s.score }}%</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% if weaknesses %}
      <div style="font-size: 11px; font-weight: 600; color: #dc2626; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px;">üéØ Focus Areas</div>
      <div class="sw-list">
        {% for w in weaknesses %}
        <div class="sw-item sw-weakness">
          <span class="sw-name">{{ w.name }}</span>
          <span class="sw-score">{{ w.score }}%</span>
        </div>
        {% endfor %}
      </div>
      {% endif %}
      {% if not strengths and not weaknesses %}
      <p style="color: #9ca3af; font-size: 13px;">Not enough data to determine strengths and weaknesses yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Recent Tests Table -->
  {% if recent_tests %}
  <div class="card">
    <h2>Recent Tests</h2>
    <div style="overflow-x: auto;">
      <table class="t-table">
        <thead>
          <tr>
            <th>Test</th>
            <th>Subject</th>
            <th>Date</th>
            <th>Score</th>
            <th>%</th>
          </tr>
        </thead>
        <tbody>
          {% for t in recent_tests %}
          <tr>
            <td style="font-weight: 500;">{{ t.title|truncatechars:40 }}</td>
            <td>{{ t.subject }}</td>
            <td style="white-space: nowrap;">{{ t.date }}</td>
            <td>{{ t.earned }}/{{ t.total }}</td>
            <td>
              <span class="score-badge {% if t.percentage >= 80 %}sb-green{% elif t.percentage >= 60 %}sb-blue{% elif t.percentage >= 40 %}sb-yellow{% else %}sb-red{% endif %}">
                {{ t.percentage }}%
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% else %}
  <!-- Empty State -->
  <div class="card">
    <div class="empty-box">
      <div class="em-icon">üìö</div>
      <h3 style="font-size: 18px; color: #374151; margin-bottom: 6px;">No Test Data Yet</h3>
      <p style="font-size: 14px; color: #6b7280;">Complete some tests to see your performance analytics here.</p>
    </div>
  </div>
  {% endif %}

</div>

{% if timeline|length >= 2 %}
<script>
(function() {
  var data = [{% for t in timeline %}{{ t.percentage }}{% if not forloop.last %},{% endif %}{% endfor %}];
  var labels = [{% for t in timeline %}"{{ t.date }}"{% if not forloop.last %},{% endif %}{% endfor %}];
  var svg = document.getElementById('trendSvg');
  if (!svg || data.length < 2) return;

  var W = 400, H = 60, pad = 4;
  var minV = Math.max(0, Math.min.apply(null, data) - 5);
  var maxV = Math.min(100, Math.max.apply(null, data) + 5);
  var range = maxV - minV || 1;

  // Build path
  var pts = [];
  for (var i = 0; i < data.length; i++) {
    var x = pad + (i / (data.length - 1)) * (W - 2 * pad);
    var y = H - pad - ((data[i] - minV) / range) * (H - 2 * pad);
    pts.push(x + ',' + y);
  }

  // Gradient fill
  var grad = '<defs><linearGradient id="tg" x1="0" y1="0" x2="0" y2="1">' +
    '<stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/>' +
    '<stop offset="100%" stop-color="#3b82f6" stop-opacity="0.02"/>' +
    '</linearGradient></defs>';

  // Area
  var area = '<polygon points="' + pad + ',' + (H - pad) + ' ' + pts.join(' ') + ' ' + (W - pad) + ',' + (H - pad) + '" fill="url(#tg)" />';

  // Line
  var line = '<polyline points="' + pts.join(' ') + '" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linejoin="round" />';

  // Dots
  var dots = '';
  for (var j = 0; j < data.length; j++) {
    var dx = pad + (j / (data.length - 1)) * (W - 2 * pad);
    var dy = H - pad - ((data[j] - minV) / range) * (H - 2 * pad);
    var col = data[j] >= 80 ? '#059669' : data[j] >= 60 ? '#3b82f6' : data[j] >= 40 ? '#d97706' : '#dc2626';
    dots += '<circle cx="' + dx + '" cy="' + dy + '" r="3.5" fill="' + col + '" stroke="white" stroke-width="1.5" />';
    // Score labels for first, last, min, max
    if (j === 0 || j === data.length - 1) {
      dots += '<text x="' + dx + '" y="' + (dy - 6) + '" text-anchor="middle" font-size="9" fill="#6b7280" font-weight="600">' + data[j] + '%</text>';
    }
  }

  svg.innerHTML = grad + area + line + dots;
})();
</script>
{% endif %}

{% endblock %}
