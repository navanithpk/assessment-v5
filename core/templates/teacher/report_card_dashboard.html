<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Report Cards | Lumen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary: #1a73e8;
            --surface: #f8f9fa;
            --on-surface: #202124;
            --outline: #dadce0;
            --success: #1e8e3e;
            --warning: #f9ab00;
            --error: #d93025;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--surface);
            color: var(--on-surface);
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        h1 {
            font-family: 'Google Sans', sans-serif;
            font-size: 32px;
            font-weight: 500;
        }

        .subtitle {
            color: #5f6368;
            font-size: 14px;
            margin-top: 4px;
        }

        /* Filter Panel */
        .filter-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 500;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 10px 12px;
            border: 1px solid var(--outline);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box .material-symbols-rounded {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #5f6368;
            pointer-events: none;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }

        .btn-secondary {
            background: white;
            color: var(--on-surface);
            border: 1px solid var(--outline);
        }

        .btn-secondary:hover {
            background: var(--surface);
        }

        /* Students Table */
        .students-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--surface);
        }

        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #5f6368;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px;
            border-top: 1px solid var(--outline);
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .student-name {
            font-weight: 500;
            color: var(--on-surface);
        }

        .student-id {
            font-size: 12px;
            color: #5f6368;
            margin-top: 2px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #ceead6;
            color: #137333;
        }

        .badge-warning {
            background: #feefc3;
            color: #b06000;
        }

        .badge-error {
            background: #fad2cf;
            color: #c5221f;
        }

        .btn-icon {
            padding: 8px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
            color: var(--primary);
        }

        .btn-icon:hover {
            background: rgba(26, 115, 232, 0.1);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--outline);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .page-info {
            font-size: 14px;
            color: #5f6368;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: #5f6368;
        }

        .empty-state .material-symbols-rounded {
            font-size: 64px;
            color: #dadce0;
            margin-bottom: 16px;
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 32px;
            border-radius: 12px;
            text-align: center;
        }

        .spinner {
            border: 3px solid var(--outline);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ðŸ“‹ Report Cards</h1>
                <p class="subtitle">Generate comprehensive student performance reports</p>
            </div>
            <a href="{% url 'teacher_dashboard' %}" class="btn btn-secondary">
                <span class="material-symbols-rounded">arrow_back</span>
                Back to Dashboard
            </a>
        </header>

        <!-- Filter Panel -->
        <div class="filter-panel">
            <form method="GET" id="filterForm">
                <div class="filter-grid">
                    <div class="filter-group search-box">
                        <label for="search">Search Student</label>
                        <span class="material-symbols-rounded">search</span>
                        <input
                            type="text"
                            id="search"
                            name="search"
                            placeholder="Name, Roll No, Admission ID..."
                            value="{{ filters.search }}"
                        >
                    </div>

                    <div class="filter-group">
                        <label for="grade">Grade</label>
                        <select id="grade" name="grade">
                            <option value="">All Grades</option>
                            {% for grade in grades %}
                            <option value="{{ grade.id }}" {% if filters.grade == grade.id|stringformat:"s" %}selected{% endif %}>
                                {{ grade.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="cohort">Cohort/Group</label>
                        <select id="cohort" name="cohort">
                            <option value="">All Students</option>
                            {% for cohort in cohorts %}
                            <option value="{{ cohort.id }}" {% if filters.cohort == cohort.id|stringformat:"s" %}selected{% endif %}>
                                {{ cohort.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="subject">Subject</label>
                        <select id="subject" name="subject">
                            <option value="">All Subjects</option>
                            {% for subject in subjects %}
                            <option value="{{ subject.id }}" {% if filters.subject == subject.id|stringformat:"s" %}selected{% endif %}>
                                {{ subject.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="date_from">From Date</label>
                        <input type="date" id="date_from" name="date_from" value="{{ filters.date_from }}">
                    </div>

                    <div class="filter-group">
                        <label for="date_to">To Date</label>
                        <input type="date" id="date_to" name="date_to" value="{{ filters.date_to }}">
                    </div>
                </div>

                <div class="filter-actions">
                    <button type="submit" class="btn btn-primary">
                        <span class="material-symbols-rounded">filter_list</span>
                        Apply Filters
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                        <span class="material-symbols-rounded">clear</span>
                        Clear All
                    </button>
                </div>
            </form>
        </div>

        <!-- Students Table -->
        <div class="students-table">
            {% if students_data %}
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Grade & Section</th>
                        <th>Tests Taken</th>
                        <th>Average Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in students_data %}
                    <tr>
                        <td>
                            <div class="student-name">{{ data.student.full_name }}</div>
                            <div class="student-id">
                                Roll: {{ data.student.roll_number }}
                                {% if data.student.admission_id %}| ID: {{ data.student.admission_id }}{% endif %}
                            </div>
                        </td>
                        <td>{{ data.student.grade.name }}-{{ data.student.section }}</td>
                        <td>{{ data.test_count }}</td>
                        <td><strong>{{ data.avg_score }}%</strong></td>
                        <td>
                            <span class="badge {% if data.avg_score >= 80 %}badge-success{% elif data.avg_score >= 60 %}badge-warning{% else %}badge-error{% endif %}">
                                {{ data.status }}
                            </span>
                        </td>
                        <td>
                            <button
                                class="btn-icon"
                                onclick="generateReportCard({{ data.student.id }}, '{{ data.student.full_name }}')"
                                title="Generate PDF Report Card"
                            >
                                <span class="material-symbols-rounded">picture_as_pdf</span>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                <button class="pagination-btn" onclick="goToPage(1)">First</button>
                <button class="pagination-btn" onclick="goToPage({{ page_obj.previous_page_number }})">Previous</button>
                {% endif %}

                <span class="page-info">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <button class="pagination-btn" onclick="goToPage({{ page_obj.next_page_number }})">Next</button>
                <button class="pagination-btn" onclick="goToPage({{ page_obj.paginator.num_pages }})">Last</button>
                {% endif %}
            </div>
            {% endif %}

            {% else %}
            <div class="empty-state">
                <span class="material-symbols-rounded">search_off</span>
                <h3>No students found</h3>
                <p>Try adjusting your search criteria or filters</p>
            </div>
            {% endif %}
        </div>

        <p class="subtitle" style="margin-top: 16px; text-align: center;">
            Showing {{ students_data|length }} of {{ total_count }} student{{ total_count|pluralize }}
        </p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Generating report card...</p>
        </div>
    </div>

    <script>
        function clearFilters() {
            document.getElementById('search').value = '';
            document.getElementById('grade').value = '';
            document.getElementById('cohort').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('date_from').value = '';
            document.getElementById('date_to').value = '';
            document.getElementById('filterForm').submit();
        }

        function goToPage(pageNum) {
            const url = new URL(window.location);
            url.searchParams.set('page', pageNum);
            window.location = url;
        }

        async function generateReportCard(studentId, studentName) {
            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                // Get current filters
                const subject = document.getElementById('subject').value;
                const dateFrom = document.getElementById('date_from').value;
                const dateTo = document.getElementById('date_to').value;

                // Build API URL with filters
                const url = new URL(`/teacher/report-cards/${studentId}/data/`, window.location.origin);
                if (subject) url.searchParams.set('subject', subject);
                if (dateFrom) url.searchParams.set('date_from', dateFrom);
                if (dateTo) url.searchParams.set('date_to', dateTo);

                // Fetch report card data
                const response = await fetch(url);
                const data = await response.json();

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Page dimensions
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                let yPos = margin;

                // Header - School Info
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(data.school.name, margin, yPos);
                yPos += 5;
                if (data.school.address) {
                    doc.text(data.school.address, margin, yPos);
                    yPos += 5;
                }
                yPos += 10;

                // Title
                doc.setFontSize(22);
                doc.setTextColor(26, 115, 232); // Primary blue
                doc.text('ACADEMIC REPORT CARD', pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;

                // Student Info Box
                doc.setDrawColor(218, 220, 224);
                doc.setFillColor(248, 249, 250);
                doc.roundedRect(margin, yPos, pageWidth - 2 * margin, 35, 3, 3, 'FD');

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                yPos += 8;

                doc.text(`Name: ${data.student.name}`, margin + 5, yPos);
                yPos += 7;
                doc.text(`Grade: ${data.student.grade}  |  Section: ${data.student.section}`, margin + 5, yPos);
                yPos += 7;
                doc.text(`Roll Number: ${data.student.roll_number}`, margin + 5, yPos);
                yPos += 7;
                doc.text(`Admission ID: ${data.student.admission_id}`, margin + 5, yPos);
                yPos += 15;

                // Period
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`Period: ${data.period.from} to ${data.period.to}`, margin, yPos);
                yPos += 15;

                // Overall Performance Summary
                doc.setFontSize(14);
                doc.setTextColor(32, 33, 36);
                doc.text('Overall Performance', margin, yPos);
                yPos += 10;

                const summaryData = [
                    ['Total Tests', data.overall.total_tests],
                    ['Average Score', `${data.overall.average_percentage}%`],
                    ['Grade', data.overall.grade]
                ];

                doc.autoTable({
                    startY: yPos,
                    head: [['Metric', 'Value']],
                    body: summaryData,
                    theme: 'grid',
                    headStyles: { fillColor: [26, 115, 232], fontSize: 10 },
                    margin: { left: margin, right: margin },
                    tableWidth: pageWidth - 2 * margin
                });

                yPos = doc.lastAutoTable.finalY + 15;

                // Subject-wise Performance
                if (data.subjects.length > 0) {
                    // Check if we need a new page
                    if (yPos > pageHeight - 80) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFontSize(14);
                    doc.setTextColor(32, 33, 36);
                    doc.text('Subject-wise Performance', margin, yPos);
                    yPos += 10;

                    const subjectData = data.subjects.map(s => [
                        s.name,
                        s.test_count,
                        `${s.average}%`,
                        s.grade
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Subject', 'Tests', 'Average', 'Grade']],
                        body: subjectData,
                        theme: 'grid',
                        headStyles: { fillColor: [26, 115, 232], fontSize: 10 },
                        margin: { left: margin, right: margin },
                        tableWidth: pageWidth - 2 * margin
                    });

                    yPos = doc.lastAutoTable.finalY + 15;
                }

                // Individual Test Performance
                if (data.tests.length > 0) {
                    // New page for test details
                    doc.addPage();
                    yPos = margin;

                    doc.setFontSize(14);
                    doc.setTextColor(32, 33, 36);
                    doc.text('Individual Test Performance', margin, yPos);
                    yPos += 10;

                    const testData = data.tests.map(t => [
                        t.title,
                        t.subject,
                        t.date,
                        `${t.earned_marks}/${t.total_marks}`,
                        `${t.percentage}%`,
                        t.grade
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Test', 'Subject', 'Date', 'Marks', 'Score', 'Grade']],
                        body: testData,
                        theme: 'grid',
                        headStyles: { fillColor: [26, 115, 232], fontSize: 9 },
                        bodyStyles: { fontSize: 8 },
                        margin: { left: margin, right: margin },
                        tableWidth: pageWidth - 2 * margin,
                        columnStyles: {
                            0: { cellWidth: 'auto' },
                            1: { cellWidth: 30 },
                            2: { cellWidth: 25 },
                            3: { cellWidth: 25 },
                            4: { cellWidth: 20 },
                            5: { cellWidth: 20 }
                        }
                    });
                }

                // Footer on last page
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                    doc.text('Generated by Lumen Analytics', margin, pageHeight - 10);
                    doc.text(new Date().toLocaleDateString(), pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                // Save PDF
                const filename = `ReportCard_${studentName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(filename);

            } catch (error) {
                console.error('Error generating report card:', error);
                alert('Failed to generate report card. Please try again.');
            } finally {
                // Hide loading overlay
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }
    </script>
</body>
</html>
