{% extends "teacher/teacher_base.html" %}

{% block title %}Students{% endblock %}

{% block content %}
<!-- Keep all existing styles, add this: -->
<style>
/* ... all existing styles ... */
.username-badge {
  background: #dbeafe;
  color: #1e40af;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 500;
  font-family: monospace;
}

.credentials-section {
  background: #fef3c7;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 20px;
  border: 1px solid #fde68a;
}

.credentials-section h4 {
  margin: 0 0 12px 0;
  color: #92400e;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
}
</style>

<div class="students-container">
  <!-- ... keep existing header and stats ... -->

  <!-- Students Table (UPDATED) -->
  <div class="students-table-container">
    <div class="table-header">
      <h2>All Students ({{ students|length }})</h2>
    </div>

    {% if students %}
      <table class="students-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Username</th>
            <th>Roll Number</th>
            <th>Admission ID</th>
            <th>Grade</th>
            <th>Section</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="studentsTableBody">
          {% for student in students %}
            <tr data-student-id="{{ student.id }}">
              <td>
                <span class="student-name">{{ student.full_name }}</span>
              </td>
              <td>
                {% if student.user %}
                  <span class="username-badge">{{ student.user.username }}</span>
                {% else %}
                  <span style="color: #9ca3af;">No account</span>
                {% endif %}
              </td>
              <td>{{ student.roll_number|default:"â€”" }}</td>
              <td>{{ student.admission_id|default:"â€”" }}</td>
              <td>
                <span class="badge badge-grade">{{ student.grade.name }}</span>
              </td>
              <td>
                <span class="badge badge-section">{{ student.section }}</span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="icon-btn" onclick="editStudent({{ student.id }})" title="Edit">
                    âœï¸
                  </button>
                  <button class="icon-btn delete" onclick="deleteStudent({{ student.id }})" title="Delete">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ‘¨â€ğŸ“</div>
        <h3>No students found</h3>
        <p>Add your first student to get started</p>
        <a href="{% url 'teacher_dashboard' %}" class="btn primary">
          â• Add Student
        </a>
      </div>
    {% endif %}
  </div>
</div>

<!-- Edit Student Modal (UPDATED) -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Student</h3>
      <button type="button" class="close-btn" onclick="closeEditModal()">Ã—</button>
    </div>
    
    <form id="editStudentForm">
      <input type="hidden" id="editStudentId">
      
      <div class="form-group">
        <label>Full Name *</label>
        <input type="text" id="editFullName" required>
      </div>

      <div class="form-group">
        <label>Roll Number</label>
        <input type="text" id="editRollNumber">
      </div>

      <div class="form-group">
        <label>Admission ID</label>
        <input type="text" id="editAdmissionId">
      </div>

      <div class="form-group">
        <label>Grade *</label>
        <select id="editGrade" required>
          <option value="">Select Grade</option>
          {% for grade in all_grades %}
            <option value="{{ grade.id }}">{{ grade.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>Section *</label>
        <input type="text" id="editSection" required>
      </div>

      <!-- Login Credentials Section -->
      <div class="credentials-section">
        <h4>ğŸ” Login Credentials</h4>
        
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="editUsername" placeholder="Username for login">
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
            Current username will be shown here
          </small>
        </div>

        <div class="form-group">
          <label>New Password (optional)</label>
          <input type="password" id="editPassword" placeholder="Leave empty to keep current">
          <small style="color: #6b7280; font-size: 12px; display: block; margin-top: 4px;">
            Only fill this if you want to change the password
          </small>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn secondary" onclick="closeEditModal()">
          Cancel
        </button>
        <button type="submit" class="btn primary">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function editStudent(studentId) {
  // Fetch student data
  fetch(`/teacher/students/${studentId}/get/`)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const student = data.student;
        document.getElementById('editStudentId').value = student.id;
        document.getElementById('editFullName').value = student.full_name;
        document.getElementById('editRollNumber').value = student.roll_number || '';
        document.getElementById('editAdmissionId').value = student.admission_id || '';
        document.getElementById('editGrade').value = student.grade_id;
        document.getElementById('editSection').value = student.section;
        document.getElementById('editUsername').value = student.username || '';
        document.getElementById('editPassword').value = ''; // Always empty
        
        document.getElementById('editModal').classList.add('active');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to load student data');
    });
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
}

document.getElementById('editStudentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const studentId = document.getElementById('editStudentId').value;
  const data = {
    full_name: document.getElementById('editFullName').value,
    roll_number: document.getElementById('editRollNumber').value,
    admission_id: document.getElementById('editAdmissionId').value,
    grade: document.getElementById('editGrade').value,
    section: document.getElementById('editSection').value,
    username: document.getElementById('editUsername').value,
    password: document.getElementById('editPassword').value
  };
  
  fetch(`/teacher/students/${studentId}/edit/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      closeEditModal();
      // Reload to show updated data
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update student');
  });
});

function deleteStudent(studentId) {
  if (!confirm('Are you sure you want to delete this student? This will also delete their login account and cannot be undone.')) {
    return;
  }
  
  fetch(`/teacher/students/${studentId}/delete/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      // Remove row from table
      const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
      if (row) {
        row.remove();
      }
      
      // Update count
      const totalCount = document.getElementById('totalCount');
      totalCount.textContent = parseInt(totalCount.textContent) - 1;
      
      // Check if table is empty
      const tableBody = document.getElementById('studentsTableBody');
      if (tableBody.children.length === 0) {
        location.reload();
      }
    } else {
      alert('Error deleting student');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to delete student');
  });
}

// Close modal on outside click
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target.id === 'editModal') {
    closeEditModal();
  }
});
</script>

{% endblock %}