{% extends "teacher/teacher_base.html" %}

{% block title %}Untagged Questions - AI Tagging{% endblock %}

{% block content %}

<style>
.header-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.header-card h1 {
  margin: 0 0 8px 0;
  font-size: 28px;
}

.header-card p {
  margin: 0;
  opacity: 0.9;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid #667eea;
}

.stat-label {
  font-size: 13px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: #1f2937;
}

.action-panel {
  background: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 30px;
}

.action-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 20px;
}

.action-btn {
  padding: 16px 24px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.action-btn.topics {
  background: #3b82f6;
  color: white;
}

.action-btn.topics:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.action-btn.los {
  background: #10b981;
  color: white;
}

.action-btn.los:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.action-btn.both {
  background: #8b5cf6;
  color: white;
}

.action-btn.both:hover:not(:disabled) {
  background: #7c3aed;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.progress-section {
  background: white;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 30px;
  display: none;
}

.progress-section.active {
  display: block;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.progress-title {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
}

.progress-status {
  font-size: 14px;
  color: #6b7280;
  font-weight: 600;
}

.progress-bar-container {
  width: 100%;
  height: 24px;
  background: #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 12px;
  position: relative;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: 700;
}

.progress-details {
  font-size: 13px;
  color: #6b7280;
  margin-top: 8px;
}

.log-viewer {
  max-height: 400px;
  overflow-y: auto;
  background: #f9fafb;
  border-radius: 8px;
  padding: 16px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  line-height: 1.6;
  margin-top: 16px;
}

.log-entry {
  padding: 4px 0;
  border-bottom: 1px solid #e5e7eb;
}

.log-entry:last-child {
  border-bottom: none;
}

.log-entry.success {
  color: #10b981;
}

.log-entry.error {
  color: #ef4444;
}

.log-entry.info {
  color: #3b82f6;
}

.questions-table {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  overflow: hidden;
}

.table-header {
  padding: 20px 24px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-title {
  font-size: 18px;
  font-weight: 700;
  color: #1f2937;
}

.table-filter {
  display: flex;
  gap: 12px;
}

.filter-btn {
  padding: 8px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.filter-btn.active {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th {
  background: #f9fafb;
  padding: 12px 24px;
  text-align: left;
  font-size: 13px;
  font-weight: 700;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

td {
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
}

tr:last-child td {
  border-bottom: none;
}

.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.badge.missing {
  background: #fee2e2;
  color: #dc2626;
}

.badge.tagged {
  background: #d1fae5;
  color: #059669;
}

.question-preview {
  max-width: 400px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
</style>

<div class="header-card">
  <h1>ü§ñ AI Tagging - Untagged Questions</h1>
  <p>Automatically tag topics and learning objectives for untagged questions</p>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Total Untagged</div>
    <div class="stat-value" id="totalUntagged">{{ total_untagged }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Missing Topics</div>
    <div class="stat-value" id="missingTopics">{{ missing_topics }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Missing LOs</div>
    <div class="stat-value" id="missingLOs">{{ missing_los }}</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Ready to Tag</div>
    <div class="stat-value" id="readyToTag">{{ questions|length }}</div>
  </div>
</div>

<div class="action-panel">
  <h2 style="margin: 0 0 8px 0; font-size: 18px;">Tagging Actions</h2>
  <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">
    Choose how you want to tag these questions. The process will run in the background and continue even if you navigate away.
  </p>

  <div class="action-buttons">
    <button class="action-btn topics" onclick="startTagging('topics')" id="btnTopics">
      <span>üè∑Ô∏è</span>
      <span>Tag Topics Only</span>
    </button>
    <button class="action-btn los" onclick="startTagging('los')" id="btnLOs">
      <span>üìö</span>
      <span>Tag Learning Objectives Only</span>
    </button>
    <button class="action-btn both" onclick="startTagging('both')" id="btnBoth">
      <span>üöÄ</span>
      <span>Tag Topics + LOs (Sequential)</span>
    </button>
  </div>
</div>

<div class="progress-section" id="progressSection">
  <div class="progress-header">
    <div class="progress-title" id="progressTitle">Processing...</div>
    <div class="progress-status" id="progressStatus">0 / 0</div>
  </div>

  <div class="progress-bar-container">
    <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
  </div>

  <div class="progress-details" id="progressDetails">
    Initializing...
  </div>

  <div class="log-viewer" id="logViewer"></div>

  <div style="margin-top: 16px; display: flex; gap: 12px;">
    <button class="action-btn" style="background: #6b7280; color: white; padding: 10px 20px;" onclick="toggleLogs()">
      <span id="logsToggleText">Show Logs</span>
    </button>
    <a href="/teacher/ai-logs/" target="_blank" class="action-btn" style="background: #3b82f6; color: white; padding: 10px 20px; text-decoration: none;">
      View Full Logs
    </a>
  </div>
</div>

<div class="questions-table">
  <div class="table-header">
    <div class="table-title">Untagged Questions ({{ questions|length }})</div>
    <div class="table-filter">
      <button class="filter-btn active" onclick="filterQuestions('all')">All</button>
      <button class="filter-btn" onclick="filterQuestions('no-topic')">No Topic</button>
      <button class="filter-btn" onclick="filterQuestions('no-lo')">No LOs</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Question</th>
        <th>Grade</th>
        <th>Subject</th>
        <th>Topic</th>
        <th>Learning Objectives</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="questionsTableBody">
      {% for q in questions %}
      <tr data-has-topic="{{ q.topic_id|yesno:'yes,no' }}" data-has-lo="{{ q.learning_objectives.count|yesno:'yes,no' }}">
        <td class="question-preview">{{ q.question_text|striptags|truncatewords:15 }}</td>
        <td>{{ q.grade.name }}</td>
        <td>{{ q.subject.name }}</td>
        <td>
          {% if q.topic %}
            <span class="badge tagged">{{ q.topic.name }}</span>
          {% else %}
            <span class="badge missing">Missing</span>
          {% endif %}
        </td>
        <td>
          {% if q.learning_objectives.count > 0 %}
            <span class="badge tagged">{{ q.learning_objectives.count }} LO(s)</span>
          {% else %}
            <span class="badge missing">Missing</span>
          {% endif %}
        </td>
        <td>
          <a href="{% url 'edit_question' q.id %}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600;">Edit</a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
          üéâ No untagged questions found! All questions are tagged.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const csrftoken = '{{ csrf_token }}';
let currentTaskId = null;
let pollingInterval = null;

function startTagging(mode) {
  // Disable all buttons
  document.getElementById('btnTopics').disabled = true;
  document.getElementById('btnLOs').disabled = true;
  document.getElementById('btnBoth').disabled = true;

  // Show progress section
  const progressSection = document.getElementById('progressSection');
  progressSection.classList.add('active');

  // Set title based on mode
  const titles = {
    'topics': 'üè∑Ô∏è Tagging Topics',
    'los': 'üìö Tagging Learning Objectives',
    'both': 'üöÄ Tagging Topics + Learning Objectives'
  };
  document.getElementById('progressTitle').textContent = titles[mode];

  // Start the tagging process
  fetch('/teacher/ai-tag-untagged/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({ mode: mode })
  })
  .then(r => r.json())
  .then(data => {
    if (data.task_id) {
      currentTaskId = data.task_id;
      addLog('info', `Task started: ${data.task_id}`);
      addLog('info', `Processing ${data.total_questions} questions...`);

      // Start polling for progress
      startPolling();
    } else if (data.error) {
      addLog('error', `Error: ${data.error}`);
      resetButtons();
    }
  })
  .catch(error => {
    addLog('error', `Failed to start: ${error.message}`);
    resetButtons();
  });
}

function startPolling() {
  // Poll every 2 seconds
  pollingInterval = setInterval(checkProgress, 2000);
  checkProgress(); // Initial check
}

function checkProgress() {
  if (!currentTaskId) return;

  fetch(`/teacher/ai-tag-progress/${currentTaskId}/`)
    .then(r => r.json())
    .then(data => {
      updateProgress(data);

      if (data.status === 'completed' || data.status === 'failed') {
        clearInterval(pollingInterval);
        resetButtons();

        if (data.status === 'completed') {
          addLog('success', '‚úÖ Tagging completed successfully!');
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          addLog('error', '‚ùå Tagging failed. Check logs for details.');
        }
      }
    })
    .catch(error => {
      console.error('Progress check failed:', error);
    });
}

function updateProgress(data) {
  const progressBar = document.getElementById('progressBar');
  const progressStatus = document.getElementById('progressStatus');
  const progressDetails = document.getElementById('progressDetails');

  const percent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;

  progressBar.style.width = percent + '%';
  progressBar.textContent = percent + '%';

  progressStatus.textContent = `${data.processed} / ${data.total}`;

  let details = [];
  if (data.topics_tagged > 0) details.push(`${data.topics_tagged} topics tagged`);
  if (data.los_tagged > 0) details.push(`${data.los_tagged} LOs tagged`);
  if (data.errors > 0) details.push(`${data.errors} errors`);

  progressDetails.textContent = details.join(' ‚Ä¢ ') || 'Processing...';

  // Add recent log if available
  if (data.current_question) {
    addLog('info', `Processing question ${data.processed}: ${data.current_question}`);
  }
}

function addLog(type, message) {
  const logViewer = document.getElementById('logViewer');
  const entry = document.createElement('div');
  entry.className = `log-entry ${type}`;
  const timestamp = new Date().toLocaleTimeString();
  entry.textContent = `[${timestamp}] ${message}`;
  logViewer.appendChild(entry);
  logViewer.scrollTop = logViewer.scrollHeight;
}

function toggleLogs() {
  const logViewer = document.getElementById('logViewer');
  const toggleText = document.getElementById('logsToggleText');

  if (logViewer.style.display === 'none' || !logViewer.style.display) {
    logViewer.style.display = 'block';
    toggleText.textContent = 'Hide Logs';
  } else {
    logViewer.style.display = 'none';
    toggleText.textContent = 'Show Logs';
  }
}

function resetButtons() {
  document.getElementById('btnTopics').disabled = false;
  document.getElementById('btnLOs').disabled = false;
  document.getElementById('btnBoth').disabled = false;
}

function filterQuestions(filter) {
  const rows = document.querySelectorAll('#questionsTableBody tr');
  const buttons = document.querySelectorAll('.filter-btn');

  // Update active button
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  // Filter rows
  rows.forEach(row => {
    const hasTopic = row.getAttribute('data-has-topic') === 'yes';
    const hasLO = row.getAttribute('data-has-lo') === 'yes';

    let show = true;
    if (filter === 'no-topic') {
      show = !hasTopic;
    } else if (filter === 'no-lo') {
      show = !hasLO;
    }

    row.style.display = show ? '' : 'none';
  });
}

// Hide logs initially
document.getElementById('logViewer').style.display = 'none';
</script>

{% endblock %}
