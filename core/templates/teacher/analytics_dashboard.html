{% load analytics_filters %}
{% extends "teacher/teacher_base.html" %}

{% block title %}Analytics ‚Äî {{ test.title }}{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
{% endblock %}

{% block content %}
<style>
    * { box-sizing: border-box; }

    :root {
        --md-primary: #2563eb;
        --md-surface: #f4f6f8;
        --md-on-surface: #202124;
        --md-outline: #e5e7eb;
        --risk-high: #d93025;
        --risk-medium: #f9ab00;
        --risk-low: #1e8e3e;
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        gap: 16px;
    }

    .analytics-header h1 { margin: 0; font-size: 20px; font-weight: 600; }
    .analytics-header .meta { color: #6b7280; font-size: 13px; margin-top: 3px; }

    .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 16px;
        width: 100%;
    }

    .card {
        background: white;
        border-radius: 10px;
        border: 1px solid var(--md-outline);
        padding: 18px;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .card h3 { margin: 0; font-size: 14px; font-weight: 600; }

    .span-3 { grid-column: span 3; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
    .span-8 { grid-column: span 8; }
    .span-12 { grid-column: span 12; }

    .matrix-container { overflow-x: auto; margin-top: 12px; border-radius: 8px; }
    table.matrix { width: 100%; border-collapse: separate; border-spacing: 2px; }
    .matrix th { font-size: 10px; padding: 6px 8px; background: #f1f3f4; text-align: left; }
    .matrix td { width: 28px; height: 28px; border-radius: 4px; }

    .m-mastery { background: #ceead6; }
    .m-developing { background: #feefc3; }
    .m-critical { background: #fad2cf; }

    .stat-value { font-size: 24px; font-weight: 700; color: var(--md-primary); }
    .stat-label { font-size: 11px; color: #6b7280; }

    .btn-export {
        background: var(--md-primary); color: white; border: none;
        padding: 8px 16px; border-radius: 6px; display: inline-flex; align-items: center; gap: 6px;
        font-size: 13px; font-weight: 500; cursor: pointer;
        white-space: nowrap;
    }

    .time-badge {
        display: inline-block;
        padding: 2px 7px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .time-badge.rushed { background: #fce8e6; color: #c5221f; }
    .time-badge.overthought { background: #fef7e0; color: #b06000; }
    .time-badge.challenging { background: #e8f0fe; color: #1967d2; }
    .time-badge.normal { background: #e6f4ea; color: #137333; }

    .q-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .q-table th { font-size: 11px; padding: 8px; background: #f9fafb; text-align: left; font-weight: 600; color: #6b7280; }
    .q-table td { font-size: 13px; padding: 8px; border-bottom: 1px solid #f3f4f6; }
    .q-table tr:hover td { background: #f9fafb; }

    .diff-badge {
        display: inline-block;
        padding: 2px 7px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 500;
    }
    .diff-badge.easy { background: #e6f4ea; color: #137333; }
    .diff-badge.medium { background: #fef7e0; color: #b06000; }
    .diff-badge.hard { background: #fce8e6; color: #c5221f; }

    .insight-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        background: #f1f3f4;
        margin: 3px;
    }

    @media print {
        @page { size: A4; margin: 2cm 1.5cm; }
        .btn-export { display: none !important; }
        .main { overflow: visible !important; padding: 0 !important; }
        .analytics-header { page-break-after: avoid; border-bottom: 2px solid var(--md-primary); padding-bottom: 12px; margin-bottom: 20px; }
        .card { page-break-inside: avoid; box-shadow: none !important; margin-bottom: 16px !important; }
        .grid { display: block !important; }
        .card.span-3, .card.span-4, .card.span-6, .card.span-8, .card.span-12 { width: 100% !important; }
        canvas { max-width: 100% !important; height: auto !important; page-break-inside: avoid; }
        .matrix-container { overflow: visible !important; page-break-inside: avoid; }
        .m-mastery, .m-developing, .m-critical, .time-badge, .diff-badge { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    }
</style>

<div class="analytics-header">
    <div>
        <h1>üìä {{ test.title }}</h1>
        <p class="meta">Examiner Analysis &bull; {{ analytics.students|length }} Candidates &bull; {{ test.subject.name }} &bull; {{ test.assigned_groups.all.0.name|default:"General Cohort" }}</p>
    </div>
    <button class="btn-export" onclick="window.print()">üñ® Export PDF Report</button>
</div>

{% if error %}
<div class="card" style="text-align: center; padding: 48px;">
    <span style="font-size: 40px;">üìä</span>
    <h3 style="margin-top: 12px;">{{ error }}</h3>
</div>
{% else %}

<div class="grid">
    <!-- ROW 1: Summary Stats + Quality Radar -->
    <div class="card span-8">
        <h3>Performance Summary</h3>
        <div style="display: flex; justify-content: space-between; margin-top: 18px; gap: 10px; flex-wrap: wrap;">
            <div>
                <div class="stat-label">Mean Score</div>
                <div class="stat-value">{{ analytics.distribution.mean }}%</div>
            </div>
            <div>
                <div class="stat-label">Median Score</div>
                <div class="stat-value">{{ analytics.distribution.median }}%</div>
            </div>
            <div>
                <div class="stat-label">Std Deviation</div>
                <div class="stat-value">{{ analytics.distribution.std_dev }}</div>
            </div>
            <div>
                <div class="stat-label">Discrimination Index</div>
                <div class="stat-value">{{ analytics.summary.discrimination_index }}</div>
            </div>
            <div>
                <div class="stat-label">Completion Rate</div>
                <div class="stat-value" style="color: var(--risk-low);">{{ analytics.summary.completion_rate }}%</div>
            </div>
        </div>
    </div>

    <div class="card span-4">
        <h3>Assessment Quality Radar</h3>
        <p style="font-size: 11px; color: #6b7280; margin-top: 2px; margin-bottom: 8px;">Six data-driven quality metrics</p>
        <div style="flex: 1; min-height: 160px;"><canvas id="qualityRadar"></canvas></div>
    </div>

    <!-- ROW 2: Time Intelligence (if available) -->
    {% if analytics.time_analytics.has_data %}
    <div class="card span-6">
        <h3>Time Intelligence</h3>
        <p style="font-size: 11px; color: #6b7280; margin-top: 2px;">Per-question timing analysis</p>
        <div style="flex: 1; min-height: 200px; margin-top: 8px;"><canvas id="timePerQuestionChart"></canvas></div>
    </div>

    <div class="card span-6">
        <h3>Time vs Performance</h3>
        <p style="font-size: 11px; color: #6b7280; margin-top: 2px;">
            Correlation: <strong>{{ analytics.time_analytics.time_accuracy_correlation }}</strong>
            {% if analytics.time_analytics.time_accuracy_correlation > 0.3 %}
            <span style="color: var(--risk-low);">(More time = higher scores)</span>
            {% elif analytics.time_analytics.time_accuracy_correlation < -0.3 %}
            <span style="color: var(--risk-high);">(More time = lower scores)</span>
            {% else %}
            <span style="color: #6b7280;">(Weak relationship)</span>
            {% endif %}
        </p>
        <div style="flex: 1; min-height: 200px; margin-top: 8px;"><canvas id="timeVsScoreChart"></canvas></div>
    </div>

    <div class="card span-12">
        <h3>Time-Derived Insights</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px;">
            <div class="insight-pill">‚è± Avg time per question: <strong>{{ analytics.time_analytics.avg_time_per_question }}s</strong></div>
            <div class="insight-pill">üïê Avg total time per student: <strong>{{ analytics.time_analytics.avg_total_time_minutes }} min</strong></div>
            <div class="insight-pill">‚ö° Time per mark: <strong>{{ analytics.time_analytics.time_per_mark }}s</strong></div>
            {% if analytics.time_analytics.time_accuracy_correlation > 0.3 %}
            <div class="insight-pill" style="background: #e6f4ea;">üìà Students who spent more time tended to score higher</div>
            {% elif analytics.time_analytics.time_accuracy_correlation < -0.3 %}
            <div class="insight-pill" style="background: #fce8e6;">üìâ Spending more time was associated with lower scores ‚Äî possible confusion</div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ROW 3: Question Performance Table -->
    <div class="card span-12">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
            <h3>Question Performance Breakdown</h3>
            <div style="display: flex; gap: 6px; font-size: 11px;">
                <span class="time-badge rushed">Rushed</span>
                <span class="time-badge overthought">Overthought</span>
                <span class="time-badge challenging">Challenging</span>
                <span class="time-badge normal">Normal</span>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="q-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Topic</th>
                        <th>Type</th>
                        <th>Marks</th>
                        <th>Success Rate</th>
                        <th>Difficulty</th>
                        {% if analytics.time_analytics.has_data %}
                        <th>Avg Time</th>
                        <th>Min / Max</th>
                        <th>Time Flag</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for q in analytics.questions %}
                    <tr>
                        <td style="font-weight: 600;">Q{{ q.number }}</td>
                        <td>{{ q.topic }}</td>
                        <td><span style="text-transform: uppercase; font-size: 11px; color: #6b7280;">{{ q.type }}</span></td>
                        <td>{{ q.marks }}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; height: 5px; background: #eee; border-radius: 3px; max-width: 80px;">
                                    <div style="height: 100%; width: {{ q.success_rate }}%; background: {% if q.success_rate >= 75 %}var(--risk-low){% elif q.success_rate >= 50 %}var(--risk-medium){% else %}var(--risk-high){% endif %}; border-radius: 3px;"></div>
                                </div>
                                <span style="font-weight: 500;">{{ q.success_rate }}%</span>
                            </div>
                        </td>
                        <td><span class="diff-badge {{ q.difficulty }}">{{ q.difficulty }}</span></td>
                        {% if analytics.time_analytics.has_data %}
                        <td>{% if q.avg_time != None %}{{ q.avg_time }}s{% else %}&mdash;{% endif %}</td>
                        <td style="font-size: 12px; color: #6b7280;">{% if q.min_time != None %}{{ q.min_time }}s / {{ q.max_time }}s{% else %}&mdash;{% endif %}</td>
                        <td>
                            {% if q.time_flag != "no_data" %}
                            <span class="time-badge {{ q.time_flag }}">{{ q.time_flag }}</span>
                            {% else %}
                            &mdash;
                            {% endif %}
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ROW 4: LO Competency Matrix -->
    <div class="card span-12">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
            <h3>Topic Competency Matrix (Candidate vs. Objective)</h3>
            <div style="display: flex; gap: 12px; font-size: 12px;">
                <span style="display:flex; align-items:center; gap:4px;"><div class="m-mastery" style="width:10px; height:10px; border-radius:2px;"></div> Mastery (&ge;80%)</span>
                <span style="display:flex; align-items:center; gap:4px;"><div class="m-developing" style="width:10px; height:10px; border-radius:2px;"></div> Developing (&ge;50%)</span>
                <span style="display:flex; align-items:center; gap:4px;"><div class="m-critical" style="width:10px; height:10px; border-radius:2px;"></div> Critical (&lt;50%)</span>
            </div>
        </div>
        <div class="matrix-container">
            <table class="matrix">
                <thead>
                    <tr>
                        <th style="min-width: 140px;">Student Name</th>
                        {% for lo in analytics.learning_objectives %}
                        <th title="{{ lo.name }} ({{ lo.avg_mastery }}% avg)">{{ lo.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for s in analytics.students %}
                    <tr>
                        <td style="font-size: 13px; font-weight: 500;">{{ s.name }}</td>
                        {% for lo in analytics.learning_objectives %}
                            {% with perf=s.lo_performance|get_item:lo.name %}
                                {% if perf == None %}
                                    <td style="background: #e0e0e0;" title="No data"></td>
                                {% elif perf >= 80 %}
                                    <td class="m-mastery" title="{{ perf }}%"></td>
                                {% elif perf >= 50 %}
                                    <td class="m-developing" title="{{ perf }}%"></td>
                                {% else %}
                                    <td class="m-critical" title="{{ perf }}%"></td>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ROW 5: Distribution Curve + Hardest Questions -->
    <div class="card span-6">
        <h3>Cohort Performance Curve</h3>
        <div style="flex: 1; min-height: 180px;"><canvas id="distributionChart"></canvas></div>
    </div>

    <div class="card span-6">
        <h3>Hardest Questions</h3>
        <p style="font-size: 11px; color: #6b7280; margin-top: 2px; margin-bottom: 8px;">Questions with lowest success rates</p>
        {% for q in analytics.questions|dictsortreversed:"success_rate" reversed %}
        {% if forloop.counter <= 5 %}
        <div style="padding: 8px 0; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 13px; font-weight: 600;">Q{{ q.number }}: {{ q.topic }}</div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 1px;">
                    {{ q.marks }} marks &bull; {{ q.type|upper }}
                    {% if q.avg_time != None %} &bull; Avg {{ q.avg_time }}s{% endif %}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600; color: {% if q.success_rate < 50 %}var(--risk-high){% else %}var(--risk-medium){% endif %};">{{ q.success_rate }}%</div>
                {% if q.time_flag != "no_data" and q.time_flag != "normal" %}
                <span class="time-badge {{ q.time_flag }}" style="margin-top: 3px;">{{ q.time_flag }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <!-- ROW 6: Examiner Narrative + Groups -->
    <div class="card span-12">
        <h3>Examiner Narrative &amp; Recommendations</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 32px; margin-top: 14px;">
            <div style="font-size: 14px; line-height: 1.6; color: #3c4043;">
                {{ analytics.examiner_report.overview }}

                {% if analytics.examiner_report.strengths %}
                <h4 style="margin-top: 16px; color: var(--risk-low);">Strengths</h4>
                <ul style="padding-left: 18px;">
                    {% for s in analytics.examiner_report.strengths %}<li>{{ s }}</li>{% endfor %}
                </ul>
                {% endif %}

                {% if analytics.examiner_report.weaknesses %}
                <h4 style="margin-top: 12px; color: var(--risk-high);">Areas for Improvement</h4>
                <ul style="padding-left: 18px;">
                    {% for w in analytics.examiner_report.weaknesses %}<li>{{ w }}</li>{% endfor %}
                </ul>
                {% endif %}

                <h4 style="margin-top: 12px;">Recommendations</h4>
                <ul style="padding-left: 18px;">
                    {% for r in analytics.examiner_report.recommendations %}<li>{{ r }}</li>{% endfor %}
                </ul>
            </div>
            <div style="background: #f9fafb; padding: 16px; border-radius: 10px; align-self: start; border: 1px solid var(--md-outline);">
                <h4 style="margin: 0 0 10px 0; font-size: 13px;">Differentiated Groups</h4>
                <div style="font-size: 13px;">
                    {% if analytics.differentiated_groups.extension.count > 0 %}
                    <p>
                        <strong style="color: var(--risk-low);">Extension Group:</strong>
                        {{ analytics.differentiated_groups.extension.count }} Candidate{{ analytics.differentiated_groups.extension.count|pluralize }} ready for enrichment tasks.
                        <br><small style="color: #9ca3af; font-size: 11px;">{{ analytics.differentiated_groups.extension.students|join:", " }}</small>
                    </p>
                    {% else %}
                    <p><strong>Extension Group:</strong> No candidates currently qualify (&ge;80%).</p>
                    {% endif %}

                    {% if analytics.differentiated_groups.intervention.count > 0 %}
                    <p style="margin-top: 10px;">
                        <strong style="color: var(--risk-high);">Intervention Group:</strong>
                        {{ analytics.differentiated_groups.intervention.count }} Candidate{{ analytics.differentiated_groups.intervention.count|pluralize }} require re-teaching on
                        <strong>{{ analytics.differentiated_groups.intervention.focus_area }}</strong>.
                        <br><small style="color: #9ca3af; font-size: 11px;">{{ analytics.differentiated_groups.intervention.students|join:", " }}</small>
                    </p>
                    {% else %}
                    <p style="margin-top: 10px;"><strong>Intervention Group:</strong> All candidates performing adequately (&ge;50%).</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<script>
    window.onload = function() {
        {% if not error %}

        // ‚îÄ‚îÄ Assessment Quality Radar ‚îÄ‚îÄ
        new Chart(document.getElementById('qualityRadar'), {
            type: 'radar',
            data: {
                labels: ['Variety', 'Balance', 'Discrimination', 'Coverage', 'Reliability', 'Performance'],
                datasets: [{
                    label: 'Quality Score',
                    data: {{ analytics.assessment_quality_radar|safe }},
                    backgroundColor: 'rgba(37, 99, 235, 0.15)',
                    borderColor: '#2563eb',
                    pointRadius: 3,
                    pointBackgroundColor: '#2563eb',
                    borderWidth: 2
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                var labels = {
                                    'Variety': 'Question Type Variety',
                                    'Balance': 'Difficulty Balance (ideal: 20/60/20)',
                                    'Discrimination': 'Top 27% vs Bottom 27%',
                                    'Coverage': 'Topic Diversity',
                                    'Reliability': 'Score Consistency',
                                    'Performance': 'Mean Cohort Score'
                                };
                                return labels[context[0].label] || context[0].label;
                            },
                            label: function(context) {
                                return context.parsed.r.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: { r: {
                    ticks: { display: false },
                    min: 0,
                    max: 100,
                    grid: { color: 'rgba(0,0,0,0.1)' }
                } }
            }
        });

        // ‚îÄ‚îÄ Distribution Curve ‚îÄ‚îÄ
        new Chart(document.getElementById('distributionChart'), {
            type: 'line',
            data: {
                labels: {{ analytics.distribution.curve.x|safe }},
                datasets: [{
                    data: {{ analytics.distribution.curve.y|safe }},
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderColor: '#2563eb',
                    tension: 0.4,
                    pointRadius: 0
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { display: false },
                    x: {
                        grid: { display: false },
                        title: { display: true, text: 'Score (%)', font: { size: 11 } }
                    }
                }
            }
        });

        {% if analytics.time_analytics.has_data %}
        // ‚îÄ‚îÄ Time Per Question Bar Chart ‚îÄ‚îÄ
        var qLabels = [];
        var qTimes = [];
        var qColors = [];
        var qData = {{ analytics.questions|safe }};

        for (var i = 0; i < qData.length; i++) {
            qLabels.push('Q' + qData[i].number);
            qTimes.push(qData[i].avg_time || 0);
            var flag = qData[i].time_flag || 'normal';
            if (flag === 'rushed') qColors.push('#d93025');
            else if (flag === 'overthought') qColors.push('#f9ab00');
            else if (flag === 'challenging') qColors.push('#2563eb');
            else qColors.push('#1e8e3e');
        }

        new Chart(document.getElementById('timePerQuestionChart'), {
            type: 'bar',
            data: {
                labels: qLabels,
                datasets: [{
                    label: 'Avg Time (seconds)',
                    data: qTimes,
                    backgroundColor: qColors,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                var q = qData[context.dataIndex];
                                var lines = ['Success: ' + q.success_rate + '%'];
                                if (q.time_flag && q.time_flag !== 'no_data') {
                                    lines.push('Flag: ' + q.time_flag);
                                }
                                return lines;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Seconds', font: { size: 11 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // ‚îÄ‚îÄ Time vs Score Scatter ‚îÄ‚îÄ
        var scatterData = {{ analytics.time_analytics.student_time_score|safe }};
        var scatterPoints = [];
        for (var j = 0; j < scatterData.length; j++) {
            scatterPoints.push({ x: scatterData[j].time, y: scatterData[j].score });
        }

        new Chart(document.getElementById('timeVsScoreChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Students',
                    data: scatterPoints,
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                var sd = scatterData[context.dataIndex];
                                return sd.name + ': ' + sd.time + ' min, ' + sd.score + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Total Time (minutes)', font: { size: 11 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    y: {
                        title: { display: true, text: 'Score (%)', font: { size: 11 } },
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    }
                }
            }
        });
        {% endif %}

        {% endif %}
    };
</script>
{% endblock %}
