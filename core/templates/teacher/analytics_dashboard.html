{% extends 'teacher/teacher_base.html' %}

{% block title %}Class Analytics{% endblock %}

{% block content %}
<style>
    .analytics-container {
        padding: 24px;
    }

    .analytics-header {
        margin-bottom: 32px;
    }

    .analytics-header h1 {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 8px;
    }

    .filter-panel {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 24px;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 16px;
    }

    .filter-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
    }

    .filter-group select, .filter-group input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    .btn-filter {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: white;
        color: #667eea;
        border: 1px solid #667eea;
    }

    .view-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .view-tab {
        padding: 10px 20px;
        border-radius: 8px;
        background: white;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        color: #666;
        transition: all 0.2s;
    }

    .view-tab:hover {
        background: #f5f5f5;
    }

    .view-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-bottom: 16px;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 4px;
    }

    .stat-label {
        color: #666;
        font-size: 14px;
    }

    .section-title {
        font-size: 24px;
        font-weight: 700;
        margin: 32px 0 20px 0;
        color: #1a1a1a;
    }

    .data-table {
        width: 100%;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .data-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }

    .data-table td {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
    }

    .data-table tr:last-child td {
        border-bottom: none;
    }

    .data-table tr:hover {
        background: #f9f9f9;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-green {
        background: #d4edda;
        color: #155724;
    }

    .badge-yellow {
        background: #fff3cd;
        color: #856404;
    }

    .badge-red {
        background: #f8d7da;
        color: #721c24;
    }

    .heatmap {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .heatmap-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .heatmap-bar-container {
        width: 60%;
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
    }

    .heatmap-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s;
    }

    .heatmap-bar.green {
        background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
    }

    .heatmap-bar.yellow {
        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .heatmap-bar.red {
        background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);
    }

    .at-risk-section {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);
    }

    .at-risk-list {
        margin-top: 20px;
        display: grid;
        gap: 12px;
    }

    .at-risk-item {
        background: rgba(255,255,255,0.2);
        padding: 16px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
    }
</style>

<div class="analytics-container">
    <div class="analytics-header">
        <h1>üìä Class Analytics Dashboard</h1>
        <p>Comprehensive performance insights for your students</p>
    </div>

    <!-- Filters -->
    <div class="filter-panel">
        <form method="GET" action="">
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Grade</label>
                    <select name="grade">
                        <option value="">All Grades</option>
                        {% for grade in grades %}
                            <option value="{{ grade.id }}" {% if selected_grade.id == grade.id %}selected{% endif %}>
                                {{ grade.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Section</label>
                    <input type="text" name="section" placeholder="e.g., A, B" value="{{ selected_section|default:'' }}">
                </div>

                <div class="filter-group">
                    <label>Class Group</label>
                    <select name="group">
                        <option value="">All Students</option>
                        {% for group in class_groups %}
                            <option value="{{ group.id }}" {% if selected_group.id == group.id %}selected{% endif %}>
                                {{ group.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="filter-group">
                    <label>Time Range</label>
                    <select name="range">
                        <option value="1m" {% if time_range == '1m' %}selected{% endif %}>Last Month</option>
                        <option value="3m" {% if time_range == '3m' %}selected{% endif %}>Last 3 Months</option>
                        <option value="6m" {% if time_range == '6m' %}selected{% endif %}>Last 6 Months</option>
                        <option value="1y" {% if time_range == '1y' %}selected{% endif %}>Last Year</option>
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn-filter btn-primary">Apply Filters</button>
                <a href="{% url 'teacher_analytics' %}" class="btn-filter btn-secondary">Reset</a>
            </div>
        </form>
    </div>

    <!-- View Tabs -->
    <div class="view-tabs">
        <a href="?view=overview&{{ request.GET.urlencode }}" class="view-tab {% if view_type == 'overview' %}active{% endif %}">
            Class Overview
        </a>
        <a href="?view=student&{{ request.GET.urlencode }}" class="view-tab {% if view_type == 'student' %}active{% endif %}">
            Individual Student
        </a>
        <a href="?view=comparative&{{ request.GET.urlencode }}" class="view-tab {% if view_type == 'comparative' %}active{% endif %}">
            Comparative Analysis
        </a>
    </div>

    <!-- Overview View -->
    {% if view_type == 'overview' %}
        <!-- Class Average Stats -->
        <h2 class="section-title">üìä Class Performance by Subject</h2>

        {% if class_average_per_subject %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Mean</th>
                        <th>Median</th>
                        <th>Std Dev</th>
                        <th>Questions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subject in class_average_per_subject %}
                        <tr>
                            <td><strong>{{ subject.subject }}</strong></td>
                            <td>{{ subject.mean }}%</td>
                            <td>{{ subject.median }}%</td>
                            <td>{{ subject.std_dev }}</td>
                            <td>{{ subject.count }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div>No class performance data available for the selected filters.</div>
            </div>
        {% endif %}

        <!-- LO Mastery Heatmap -->
        <h2 class="section-title">üéØ Learning Objective Mastery Heatmap</h2>

        {% if lo_mastery_heatmap %}
            <div class="heatmap">
                {% for lo in lo_mastery_heatmap %}
                    <div class="heatmap-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">{{ lo.lo }}</div>
                            <div style="font-size: 13px; color: #666;">
                                {{ lo.students_mastered }}/{{ lo.total_students }} students
                            </div>
                        </div>

                        <div style="width: 100px; text-align: center; font-weight: 700;">
                            {{ lo.mastery_percentage }}%
                        </div>

                        <div class="heatmap-bar-container">
                            <div class="heatmap-bar {% if lo.mastery_percentage >= 70 %}green{% elif lo.mastery_percentage >= 40 %}yellow{% else %}red{% endif %}"
                                 style="width: {{ lo.mastery_percentage }}%"></div>
                        </div>

                        {% if lo.is_red_zone %}
                            <span class="badge badge-red" style="margin-left: 12px;">RED ZONE</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <div>No LO mastery data available.</div>
            </div>
        {% endif %}

        <!-- At-Risk Students -->
        <h2 class="section-title">‚ö†Ô∏è At-Risk Students</h2>

        {% if at_risk_students %}
            <div class="at-risk-section">
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Students Needing Attention</h3>
                <p>These students are performing below 40% average</p>

                <div class="at-risk-list">
                    {% for student_data in at_risk_students %}
                        <div class="at-risk-item">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 700; font-size: 16px;">{{ student_data.student.full_name }}</div>
                                    <div style="font-size: 14px; opacity: 0.9;">
                                        {{ student_data.student.grade }}-{{ student_data.student.section }}
                                    </div>
                                </div>
                                <div style="font-size: 28px; font-weight: 700;">
                                    {{ student_data.average }}%
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div style="background: #d4edda; color: #155724; border-radius: 12px; padding: 32px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 12px;">‚úÖ</div>
                <div style="font-size: 18px; font-weight: 600;">No at-risk students detected!</div>
                <div style="margin-top: 8px;">All students are performing above threshold.</div>
            </div>
        {% endif %}

    {% elif view_type == 'student' %}
        <!-- Individual Student View -->
        <div class="filter-panel">
            <form method="GET">
                <input type="hidden" name="view" value="student">
                {% for key, value in request.GET.items %}
                    {% if key != 'student_id' and key != 'view' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}

                <div class="filter-group">
                    <label>Select Student</label>
                    <select name="student_id" onchange="this.form.submit()">
                        <option value="">Choose a student...</option>
                        {% for student in students %}
                            <option value="{{ student.id }}" {% if selected_student.id == student.id %}selected{% endif %}>
                                {{ student.full_name }} ({{ student.grade }}-{{ student.section }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>

        {% if selected_student %}
            <h2 class="section-title">Student: {{ selected_student.full_name }}</h2>

            <!-- Student metrics would go here - similar to student view -->
            <div class="stats-grid">
                {% if student_subject_performance %}
                    {% for subject in student_subject_performance %}
                        <div class="stat-card">
                            <div class="stat-icon">üìö</div>
                            <div class="stat-value">{{ subject.avg_percentage }}%</div>
                            <div class="stat-label">{{ subject.subject }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>

            <!-- Topic Performance -->
            {% if student_topic_performance %}
                <h3 class="section-title">Topic Performance</h3>
                <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    {% for topic in student_topic_performance %}
                        <div style="padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">{{ topic.topic }}</div>
                                    <div style="font-size: 13px; color: #666; margin-top: 4px;">
                                        {{ topic.questions_attempted }} questions attempted
                                    </div>
                                </div>
                                <div>
                                    <span class="badge {% if topic.classification == 'strong' %}badge-green{% elif topic.classification == 'moderate' %}badge-yellow{% else %}badge-red{% endif %}">
                                        {{ topic.mastery_percentage }}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>
{% endblock %}
