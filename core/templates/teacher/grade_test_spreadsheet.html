{% extends "teacher/teacher_base.html" %}

{% block title %}Grade Test - {{ test.title }}{% endblock %}

{% block content %}
<style>
* { box-sizing: border-box; }

.grade-header {
  background: white;
  border-radius: 12px;
  padding: 20px 24px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-info h2 {
  margin: 0 0 4px 0;
  font-size: 20px;
  color: #1f2937;
}

.header-info p {
  margin: 0;
  font-size: 14px;
  color: #6b7280;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-draft {
  background: #f3f4f6;
  color: #374151;
}

.btn-draft:hover {
  background: #e5e7eb;
}

.btn-auto-zero {
  background: #8b5cf6;
  color: white;
}

.btn-auto-zero:hover {
  background: #7c3aed;
}

.btn-ai-grade {
  background: #f59e0b;
  color: white;
}

.btn-ai-grade:hover {
  background: #d97706;
}

.btn-publish {
  background: #10b981;
  color: white;
}

.btn-publish:hover {
  background: #059669;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Checkbox Column */
.checkbox-col {
  width: 50px;
  text-align: center;
}

.select-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.select-all-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

/* Spreadsheet Table */
.spreadsheet-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  overflow: auto;
  max-height: calc(100vh - 200px);
}

.grade-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 800px;
}

.grade-table thead {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #f9fafb;
}

.grade-table th {
  padding: 16px 12px;
  text-align: left;
  font-size: 13px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid #e5e7eb;
  white-space: nowrap;
}

.grade-table th.student-col {
  position: sticky;
  left: 0;
  background: #f9fafb;
  z-index: 11;
  min-width: 200px;
  max-width: 200px;
  border-right: 2px solid #e5e7eb;
}

.grade-table td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
  font-size: 14px;
  vertical-align: top;
}

.grade-table tbody tr:hover {
  background: #f9fafb;
}

.grade-table td.student-col {
  position: sticky;
  left: 0;
  background: white;
  border-right: 2px solid #e5e7eb;
  z-index: 5;
  font-weight: 600;
  color: #1f2937;
}

.grade-table tbody tr:hover td.student-col {
  background: #f9fafb;
}

.answer-cell {
  max-width: 200px;
  cursor: pointer;
  position: relative;
  padding: 8px;
  border-radius: 6px;
  transition: all 0.2s;
}

.answer-cell:hover {
  background: #eff6ff;
  box-shadow: 0 0 0 2px #2563eb;
}

.answer-preview {
  max-height: 80px;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 13px;
  color: #4b5563;
  line-height: 1.4;
  margin-bottom: 8px;
  word-wrap: break-word;
}

.answer-preview img {
  max-width: 100%;
  max-height: 60px;
  object-fit: contain;
  border-radius: 4px;
}

.answer-empty {
  color: #9ca3af;
  font-style: italic;
  font-size: 12px;
}

.marks-input-cell {
  display: flex;
  gap: 8px;
  align-items: center;
}

.marks-input {
  width: 70px;
  padding: 6px 8px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 14px;
  text-align: center;
}

.marks-input:focus {
  outline: none;
  border-color: #2563eb;
}

.marks-input.graded {
  background: #d1fae5;
  border-color: #10b981;
}

.max-marks {
  font-size: 12px;
  color: #6b7280;
}

/* Modal for Descriptive Responses */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 16px;
  width: 90%;
  max-width: 1000px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
  padding: 24px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-title {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
}

.modal-close:hover {
  background: #f3f4f6;
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.modal-section {
  margin-bottom: 24px;
}

.modal-section-label {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.modal-answer-display {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px;
  font-size: 14px;
  line-height: 1.6;
  color: #1f2937;
  max-height: 400px;
  overflow-y: auto;
}

.modal-answer-display img {
  max-width: 100%;
  height: auto;
  margin: 12px 0;
  border-radius: 8px;
}

.modal-footer {
  padding: 20px 24px;
  border-top: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.modal-nav-info {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

.modal-grading {
  display: flex;
  gap: 12px;
  align-items: center;
}

.keyboard-hint {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #1f2937;
  color: white;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
  z-index: 1001;
}

.keyboard-hint.visible {
  opacity: 1;
}

.kbd {
  background: #374151;
  padding: 2px 6px;
  border-radius: 3px;
  font-family: monospace;
  font-size: 11px;
  margin: 0 2px;
}
</style>

<div class="grade-header">
  <div class="header-info">
    <h2>{{ test.title }}</h2>
    <p>Grading {{ students_with_answers.count }} student(s)</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-ai-grade" onclick="aiGradeSelected()" id="aiGradeBtn">
      ü§ñ AI Grade Selected (<span id="selectedCount">0</span>)
    </button>
    <button class="btn btn-auto-zero" onclick="autoZeroUnattempted()">
      Zero Unattempted
    </button>
    <button class="btn btn-draft" onclick="saveDraft()">
      üíæ Save Draft
    </button>
    <button class="btn btn-publish" onclick="publishResults()">
      ‚úÖ Publish Results
    </button>
  </div>
</div>

<div class="spreadsheet-container">
  <table class="grade-table">
    <thead>
      <tr>
        <th class="checkbox-col">
          <div class="select-all-container">
            <input type="checkbox" id="selectAll" class="select-checkbox" onchange="toggleSelectAll(this)">
          </div>
        </th>
        <th class="student-col">Student</th>
        {% for question in questions %}
        <th>Q{{ forloop.counter }}<br><span class="max-marks">({{ question.marks }}m)</span></th>
        {% endfor %}
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for student_data in grading_spreadsheet %}
      <tr data-student-id="{{ student_data.student.id }}">
        <td class="checkbox-col">
          <input type="checkbox"
                 class="select-checkbox student-checkbox"
                 data-student-id="{{ student_data.student.id }}"
                 onchange="updateSelectedCount()">
        </td>
        <td class="student-col">
          <div>{{ student_data.student.full_name }}</div>
          <div style="font-size: 12px; color: #6b7280; font-weight: normal;">
            {{ student_data.student.grade }}-{{ student_data.student.section }}
          </div>
        </td>
        {% for answer in student_data.answers %}
        <td>
          <div class="answer-cell"
               data-student-id="{{ student_data.student.id }}"
               data-question-index="{{ forloop.counter0 }}"
               onclick="openModal({{ student_data.student.id }}, {{ forloop.counter0 }})">
            <div class="answer-preview">
              {% if answer.answer_text %}
                {{ answer.answer_text|safe|truncatewords_html:15 }}
              {% else %}
                <span class="answer-empty">No answer</span>
              {% endif %}
            </div>
            <div class="marks-input-cell" onclick="event.stopPropagation()">
              <input type="number"
                     class="marks-input {% if answer.marks_awarded is not None %}graded{% endif %}"
                     data-answer-id="{{ answer.id }}"
                     data-max-marks="{{ answer.max_marks }}"
                     min="0"
                     max="{{ answer.max_marks }}"
                     step="0.5"
                     value="{{ answer.marks_awarded|default:'' }}"
                     placeholder="0"
                     onchange="saveMarks(this)">
              <span class="max-marks">/{{ answer.max_marks }}</span>
            </div>
          </div>
        </td>
        {% endfor %}
        <td>
          <strong>{{ student_data.total_marks|floatformat:1 }}</strong> / {{ student_data.max_total }}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="100" style="text-align: center; padding: 40px; color: #9ca3af;">
          No student submissions yet
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal for Descriptive Responses -->
<div class="modal" id="answerModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Student Answer</div>
      <button class="modal-close" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div class="modal-section-label">Student Answer</div>
        <div class="modal-answer-display" id="modalAnswer">
          <!-- Answer content will be loaded here -->
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-nav-info" id="modalNavInfo">
        <!-- Navigation info -->
      </div>
      <div class="modal-grading">
        <input type="number"
               class="marks-input"
               id="modalMarksInput"
               min="0"
               step="0.5"
               placeholder="0"
               onchange="saveMarksFromModal()">
        <span class="max-marks" id="modalMaxMarks"></span>
      </div>
    </div>
  </div>
</div>

<div class="keyboard-hint" id="keyboardHint">
  <kbd>Shift</kbd> + <kbd>‚Üí</kbd> Next student |
  <kbd>Shift</kbd> + <kbd>‚Üê</kbd> Prev student |
  <kbd>Shift</kbd> + <kbd>‚Üì</kbd> Next question |
  <kbd>Shift</kbd> + <kbd>‚Üë</kbd> Prev question |
  <kbd>Esc</kbd> Close
</div>

<script>
const csrftoken = '{{ csrf_token }}';
const testId = {{ test.id }};

// Modal state
let currentStudentId = null;
let currentQuestionIndex = null;
const spreadsheetData = {{ grading_spreadsheet_json|safe }};

function openModal(studentId, questionIndex) {
  currentStudentId = studentId;
  currentQuestionIndex = questionIndex;
  loadModalContent();
  document.getElementById('answerModal').classList.add('active');
  document.getElementById('keyboardHint').classList.add('visible');
}

function closeModal() {
  document.getElementById('answerModal').classList.remove('active');
  document.getElementById('keyboardHint').classList.remove('visible');
  currentStudentId = null;
  currentQuestionIndex = null;
}

function loadModalContent() {
  const studentData = spreadsheetData.find(s => s.student.id === currentStudentId);
  if (!studentData) return;

  const answerData = studentData.answers[currentQuestionIndex];
  const questionNum = currentQuestionIndex + 1;

  document.getElementById('modalTitle').textContent =
    `${studentData.student.full_name} - Question ${questionNum}`;

  document.getElementById('modalAnswer').innerHTML =
    answerData.answer_text || '<em class="answer-empty">No answer provided</em>';

  document.getElementById('modalMarksInput').value = answerData.marks_awarded || '';
  document.getElementById('modalMarksInput').max = answerData.max_marks;
  document.getElementById('modalMarksInput').dataset.answerId = answerData.id;
  document.getElementById('modalMaxMarks').textContent = `/ ${answerData.max_marks}`;

  updateModalNavInfo();
}

function updateModalNavInfo() {
  const studentData = spreadsheetData.find(s => s.student.id === currentStudentId);
  const studentIndex = spreadsheetData.findIndex(s => s.student.id === currentStudentId);
  const totalStudents = spreadsheetData.length;
  const totalQuestions = studentData.answers.length;

  document.getElementById('modalNavInfo').textContent =
    `Student ${studentIndex + 1}/${totalStudents} ‚Ä¢ Question ${currentQuestionIndex + 1}/${totalQuestions}`;
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (!document.getElementById('answerModal').classList.contains('active')) return;

  if (e.key === 'Escape') {
    closeModal();
    return;
  }

  if (!e.shiftKey) return;

  e.preventDefault();

  const studentIndex = spreadsheetData.findIndex(s => s.student.id === currentStudentId);
  const studentData = spreadsheetData[studentIndex];

  if (e.key === 'ArrowRight') {
    // Next student, same question
    if (studentIndex < spreadsheetData.length - 1) {
      currentStudentId = spreadsheetData[studentIndex + 1].student.id;
      loadModalContent();
    }
  } else if (e.key === 'ArrowLeft') {
    // Previous student, same question
    if (studentIndex > 0) {
      currentStudentId = spreadsheetData[studentIndex - 1].student.id;
      loadModalContent();
    }
  } else if (e.key === 'ArrowDown') {
    // Same student, next question
    if (currentQuestionIndex < studentData.answers.length - 1) {
      currentQuestionIndex++;
      loadModalContent();
    }
  } else if (e.key === 'ArrowUp') {
    // Same student, previous question
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      loadModalContent();
    }
  }
});

// Save marks
async function saveMarks(input) {
  const answerId = input.dataset.answerId;
  const marks = parseFloat(input.value) || 0;
  const maxMarks = parseFloat(input.dataset.maxMarks);

  if (marks > maxMarks) {
    alert(`Marks cannot exceed ${maxMarks}`);
    input.value = maxMarks;
    return;
  }

  try {
    const response = await fetch(`/teacher/tests/${testId}/save-grade/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({
        answer_id: answerId,
        marks: marks
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      input.classList.add('graded');
      // Update total
      updateStudentTotal(input);
    } else {
      console.error('Error saving marks:', data.error || 'Unknown error');
      alert('Error saving marks: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error saving marks: ' + error.message);
  }
}

function saveMarksFromModal() {
  const input = document.getElementById('modalMarksInput');
  const answerId = input.dataset.answerId;
  const marks = parseFloat(input.value) || 0;
  const maxMarks = parseFloat(input.max);

  if (marks > maxMarks) {
    alert(`Marks cannot exceed ${maxMarks}`);
    input.value = maxMarks;
    return;
  }

  // Update the spreadsheet data
  const studentData = spreadsheetData.find(s => s.student.id === currentStudentId);
  studentData.answers[currentQuestionIndex].marks_awarded = marks;

  // Find and update the corresponding input in the table
  const tableInput = document.querySelector(`input[data-answer-id="${answerId}"]`);
  if (tableInput) {
    tableInput.value = marks;
    saveMarks(tableInput);
  }
}

function updateStudentTotal(input) {
  const row = input.closest('tr');
  const inputs = row.querySelectorAll('.marks-input');
  let total = 0;

  inputs.forEach(inp => {
    const val = parseFloat(inp.value) || 0;
    total += val;
  });

  const totalCell = row.querySelector('td:last-child strong');
  if (totalCell) {
    const maxTotal = totalCell.textContent.split('/')[1].trim();
    totalCell.textContent = `${total.toFixed(1)} / ${maxTotal}`;
  }
}

// Auto-zero unattempted questions
async function autoZeroUnattempted() {
  if (!confirm('This will assign 0 marks to all unattempted questions. Continue?')) {
    return;
  }

  const unattemptedInputs = document.querySelectorAll('.marks-input:not(.graded)');
  let count = 0;

  for (const input of unattemptedInputs) {
    const answerText = input.closest('.answer-cell').querySelector('.answer-preview').textContent.trim();
    if (answerText === 'No answer' || answerText === '') {
      input.value = 0;
      await saveMarks(input);
      count++;
    }
  }

  alert(`Auto-assigned 0 marks to ${count} unattempted question(s)`);
}

function saveDraft() {
  alert('Draft saved successfully! All changes are automatically saved.');
}

async function publishResults() {
  if (!confirm('Publish results to all students? They will be able to view their grades.')) {
    return;
  }

  try {
    const response = await fetch(`/teacher/tests/${testId}/publish-results/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    });

    if (response.ok) {
      alert('Results published successfully!');
      window.location.reload();
    } else {
      alert('Error publishing results');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error publishing results');
  }
}

// Close modal when clicking outside
document.getElementById('answerModal').addEventListener('click', (e) => {
  if (e.target.id === 'answerModal') {
    closeModal();
  }
});

// Checkbox functions
function toggleSelectAll(checkbox) {
  const studentCheckboxes = document.querySelectorAll('.student-checkbox');
  studentCheckboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateSelectedCount();
}

function updateSelectedCount() {
  const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
  const count = selectedCheckboxes.length;
  document.getElementById('selectedCount').textContent = count;

  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.student-checkbox');
  const selectAllCheckbox = document.getElementById('selectAll');
  selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
}

// AI Grade Selected Students
async function aiGradeSelected() {
  const selectedCheckboxes = document.querySelectorAll('.student-checkbox:checked');

  if (selectedCheckboxes.length === 0) {
    alert('Please select at least one student to grade with AI');
    return;
  }

  if (!confirm(`AI will grade all answers for ${selectedCheckboxes.length} selected student(s) and auto-zero unattempted questions. Continue?`)) {
    return;
  }

  const selectedStudentIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.studentId));
  let gradedCount = 0;
  let errorCount = 0;

  // Show progress
  const btn = document.getElementById('aiGradeBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;

  for (const studentId of selectedStudentIds) {
    const studentData = spreadsheetData.find(s => s.student.id === studentId);
    if (!studentData) continue;

    btn.innerHTML = `ü§ñ Grading ${studentData.student.full_name}...`;

    for (let i = 0; i < studentData.answers.length; i++) {
      const answer = studentData.answers[i];

      // Skip if already graded
      if (answer.marks_awarded !== null && answer.marks_awarded !== undefined) {
        continue;
      }

      // Check if unattempted
      if (!answer.answer_text || answer.answer_text.trim() === '') {
        // Auto-zero unattempted
        const input = document.querySelector(`input[data-answer-id="${answer.id}"]`);
        if (input) {
          input.value = 0;
          await saveMarks(input);
          gradedCount++;
        }
      } else {
        // AI grade attempted questions
        try {
          const response = await fetch('/teacher/grading/ai-grade/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
              answer_id: answer.id
            })
          });

          if (response.ok) {
            const data = await response.json();
            const input = document.querySelector(`input[data-answer-id="${answer.id}"]`);
            if (input && data.suggested_marks !== undefined) {
              input.value = data.suggested_marks;
              await saveMarks(input);
              gradedCount++;
            }
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error('AI grading error:', error);
          errorCount++;
        }
      }
    }
  }

  btn.disabled = false;
  btn.innerHTML = originalText;

  if (errorCount > 0) {
    alert(`AI grading completed!\nGraded: ${gradedCount} answers\nErrors: ${errorCount} answers\n\nPlease review and adjust marks as needed.`);
  } else {
    alert(`AI grading completed! Graded ${gradedCount} answers.\n\nPlease review and adjust marks as needed.`);
  }

  // Uncheck all
  document.getElementById('selectAll').checked = false;
  toggleSelectAll(document.getElementById('selectAll'));
}
</script>

{% endblock %}
