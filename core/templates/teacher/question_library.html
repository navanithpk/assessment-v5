{% extends "teacher/teacher_base.html" %}

{% block title %}Question Library{% endblock %}

{% block content %}
{% with test_id=request.GET.import_to_test %}
{% with import_mode=test_id %}

<style>
h1 { margin-top: 0; }

.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
}

.btn.green { background: #7cb342; color: white; }
.btn.gray { background: #9e9e9e; color: white; }
.btn.blue { background: #2563eb; color: white; }

.filters {
  background: white;
  border-radius: 14px;
  padding: 18px;
  margin-bottom: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
}

.filters label {
  font-weight: 600;
  font-size: 13px;
}

.filters select,
.filters input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.topics,
.lo-box {
  margin-top: 12px;
  max-height: 220px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 12px;
  background: #fafafa;
}

.check-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 14px;
}

.check-item input {
  margin-top: 2px;
  width: 16px;
  height: 16px;
}

.table-wrap {
  background: white;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 6px 20px rgba(0,0,0,.08);
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  text-align: left;
  padding: 10px;
  font-size: 14px;
}

th { background: #f1f1f1; }

tr:not(:last-child) td {
  border-bottom: 1px solid #e0e0e0;
}

/* Sortable column headers */
th.sortable {
  cursor: pointer;
  user-select: none;
  position: relative;
  padding-right: 24px;
}

th.sortable:hover {
  background: #e0e0e0;
}

th.sortable::after {
  content: '‚áÖ';
  position: absolute;
  right: 8px;
  opacity: 0.3;
  font-size: 12px;
}

th.sortable.asc::after {
  content: '‚Üë';
  opacity: 1;
}

th.sortable.desc::after {
  content: '‚Üì';
  opacity: 1;
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 20px;
  padding: 16px;
}

.pagination a,
.pagination span {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  text-decoration: none;
  color: #374151;
  font-size: 14px;
}

.pagination a:hover {
  background: #f3f4f6;
}

.pagination .current {
  background: #2563eb;
  color: white;
  border-color: #2563eb;
}

.pagination .disabled {
  opacity: 0.4;
  pointer-events: none;
}
</style>

<div class="action-bar">
  <h1>Question Library</h1>

  <div style="display: flex; gap: 10px;">
    {% if import_mode %}
      <button class="btn blue" onclick="importSelected()">‚¨á Import Selected</button>
    {% endif %}
	{% if not import_mode %}
    <a href="{% url 'import_mcq_pdf' %}" target="_blank">
      <button class="btn blue">üìÑ Import MCQ from PDF</button>
    </a>

    <a href="{% url 'descriptive_pdf_slicer' %}" target="_blank">
      <button class="btn blue">üìã Import Structured/Theory PDF (Step 1)</button>
    </a>

    <a href="{% url 'unconfigured_questions_list' %}" target="_blank">
      <button class="btn" style="background: #8b5cf6; color: white;">üé® Configure Answer Spaces (Step 2)</button>
    </a>

    <a href="{% url 'add_question' %}" target="_blank">
      <button class="btn green">‚ûï Add Question</button>
    </a>
    <button class="btn" style="background: #ef4444; color: white;" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
      üóëÔ∏è Delete Selected (<span id="selectedCount">0</span>)
    </button>
	{% endif %}
  </div>
</div>

<form method="get" class="filters" id="filterForm">
  {% if import_mode %}
    <input type="hidden" name="import_to_test" value="{{ test_id }}">
  {% endif %}

  <div class="filter-grid">
    <div>
      <label>Grade *</label>
      <select id="gradeSelect" name="grade" required>
        <option value="">Select</option>
        {% for g in grades %}
          <option value="{{ g.id }}" {% if request.GET.grade == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Subject *</label>
      <select id="subjectSelect" name="subject" required>
        <option value="">Select</option>
        {% for s in subjects %}
          <option value="{{ s.id }}" {% if request.GET.subject == s.id|stringformat:"s" %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label>Question Type</label>
      <select name="question_type">
        <option value="">Any</option>
        <option value="mcq" {% if request.GET.question_type == "mcq" %}selected{% endif %}>MCQ</option>
        <option value="theory" {% if request.GET.question_type == "theory" %}selected{% endif %}>Theory</option>
        <option value="structured" {% if request.GET.question_type == "structured" %}selected{% endif %}>Structured</option>
        <option value="practical" {% if request.GET.question_type == "practical" %}selected{% endif %}>Practical</option>
      </select>
    </div>

    <div>
      <label>Marks</label>
      <input type="number" name="marks" value="{{ request.GET.marks }}">
    </div>
  </div>

  <div class="topics" id="topicsBox">
    <strong>Topics *</strong>
    <em>Select grade & subject</em>
  </div>

  <div class="lo-box" id="loBox">
    <strong>Learning Objectives</strong>
    <em>Select topic</em>
  </div>

  <div style="margin-top:14px;">
    <button class="btn gray" type="submit">Apply Filters</button>
  </div>
</form>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAllDelete" onchange="toggleAllDelete()"></th>
        <th class="sortable {% if current_sort == 'id' %}{{ current_order }}{% endif %}" onclick="sortBy('id')">ID</th>
        <th>Question</th>
        <th class="sortable {% if current_sort == 'marks' %}{{ current_order }}{% endif %}" onclick="sortBy('marks')">Marks</th>
        <th class="sortable {% if current_sort == 'question_type' %}{{ current_order }}{% endif %}" onclick="sortBy('question_type')">Type</th>
        <th class="sortable {% if current_sort == 'grade__name' %}{{ current_order }}{% endif %}" onclick="sortBy('grade__name')">Grade</th>
        <th class="sortable {% if current_sort == 'subject__name' %}{{ current_order }}{% endif %}" onclick="sortBy('subject__name')">Subject</th>
        <th class="sortable {% if current_sort == 'topic__name' %}{{ current_order }}{% endif %}" onclick="sortBy('topic__name')">Topic</th>
        <th class="sortable {% if current_sort == 'year' %}{{ current_order }}{% endif %}" onclick="sortBy('year')">Year</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for q in questions %}
      <tr>
        <td>
          <input  type="checkbox" value="{{ q.id }}" class="{% if import_mode %}import-check{% else %}delete-check{% endif %}"{% if not import_mode %}onchange="updateDeleteCount()"{% endif %}>
        </td>
        <td>{{ q.id }}</td>
        <td>{{ q.question_text|striptags|truncatewords:18 }}</td>
        <td>{{ q.marks }}</td>
        <td>{{ q.question_type }}</td>
        <td>{{ q.grade.name }}</td>
        <td>{{ q.subject.name }}</td>
        <td>{{ q.topic.name }}</td>
        <td>{{ q.year|default:"‚Äî" }}</td>
        <td>
          <a href="{% url 'edit_question' q.id %}" target="_blank" style="margin-right: 10px;">Edit</a>
          <button onclick="deleteQuestion({{ q.id }})" style="background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="11"><em>No questions found</em></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Pagination Controls -->
  {% if questions.has_other_pages %}
  <div class="pagination">
    {% if questions.has_previous %}
      <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">¬´ First</a>
      <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ questions.previous_page_number }}">‚Äπ Prev</a>
    {% else %}
      <span class="disabled">¬´ First</span>
      <span class="disabled">‚Äπ Prev</span>
    {% endif %}

    <span class="current">Page {{ questions.number }} of {{ questions.paginator.num_pages }}</span>

    {% if questions.has_next %}
      <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ questions.next_page_number }}">Next ‚Ä∫</a>
      <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ questions.paginator.num_pages }}">Last ¬ª</a>
    {% else %}
      <span class="disabled">Next ‚Ä∫</span>
      <span class="disabled">Last ¬ª</span>
    {% endif %}
  </div>
  {% endif %}
</div>

<script>
// Sorting function
function sortBy(field) {
  const urlParams = new URLSearchParams(window.location.search);
  const currentSort = urlParams.get('sort') || 'id';
  const currentOrder = urlParams.get('order') || 'desc';

  // Toggle order if clicking on the same column
  let newOrder = 'asc';
  if (currentSort === field && currentOrder === 'asc') {
    newOrder = 'desc';
  }

  urlParams.set('sort', field);
  urlParams.set('order', newOrder);
  urlParams.delete('page'); // Reset to page 1 when sorting

  window.location.search = urlParams.toString();
}

const gradeSelect = document.getElementById("gradeSelect");
const subjectSelect = document.getElementById("subjectSelect");
const topicsBox = document.getElementById("topicsBox");
const loBox = document.getElementById("loBox");

const selectedTopics = new Set();
const selectedLOs = new Set();

function loadTopics() {
  if (!gradeSelect.value || !subjectSelect.value) {
    topicsBox.innerHTML = "<strong>Topics *</strong><em>Select grade & subject</em>";
    loBox.innerHTML = "<strong>Learning Objectives</strong><em>Select topic</em>";
    return;
  }

  topicsBox.innerHTML = "<em>Loading topics‚Ä¶</em>";
  loBox.innerHTML = "<em>Select topic</em>";

  fetch(`/ajax/topics/?grade_id=${gradeSelect.value}&subject_id=${subjectSelect.value}`)
    .then(r => r.json())
    .then(data => {
      topicsBox.innerHTML = "<strong>Topics *</strong>";
      data.topics.forEach(t => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = t.id;

        cb.onchange = () => {
          cb.checked ? selectedTopics.add(t.id) : selectedTopics.delete(t.id);
          loadLOs(t.id);
        };

        div.appendChild(cb);
        div.appendChild(document.createTextNode(t.name));
        topicsBox.appendChild(div);
      });
    })
    .catch(error => {
      console.error('Error loading topics:', error);
      topicsBox.innerHTML = "<strong>Topics *</strong><em>Error loading topics</em>";
    });
}

function loadLOs(topicId) {
  fetch(`/ajax/los/?topic_id=${topicId}`)
    .then(r => r.json())
    .then(data => {
      loBox.innerHTML = "<strong>Learning Objectives</strong>";
      data.los.forEach(lo => {
        const div = document.createElement("div");
        div.className = "check-item";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = lo.id;

        cb.onchange = () => {
          cb.checked ? selectedLOs.add(lo.id) : selectedLOs.delete(lo.id);
        };

        div.appendChild(cb);
        div.insertAdjacentHTML(
          "beforeend",
          `<strong>${lo.code}</strong> ‚Äì ${lo.description}`
        );

        loBox.appendChild(div);
      });
    })
    .catch(error => {
      console.error('Error loading LOs:', error);
    });
}

gradeSelect.onchange = loadTopics;
subjectSelect.onchange = loadTopics;

document.getElementById("filterForm").addEventListener("submit", e => {
  selectedTopics.forEach(t => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = "topics[]";
    i.value = t;
    e.target.appendChild(i);
  });

  selectedLOs.forEach(lo => {
    const i = document.createElement("input");
    i.type = "hidden";
    i.name = "los[]";
    i.value = lo;
    e.target.appendChild(i);
  });
});

{% if import_mode %}
// Select all checkbox
document.getElementById("selectAll").onclick = function () {
  document.querySelectorAll(".q-check").forEach(cb => cb.checked = this.checked);
};

// Import selected questions
function importSelected() {
  const ids = [...document.querySelectorAll(".import-check:checked")]
    .map(cb => cb.value);

  if (!ids.length) return alert("No questions selected");

  fetch(`/teacher/tests/{{ test_id }}/add-questions/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ question_ids: ids })
  })
  .then(r => {
    if (r.ok) {
      alert(`${ids.length} question(s) added to test successfully!`);
      
      // If opened in a new window, notify parent and close
      if (window.opener) {
        // Tell the parent window to reload
        window.opener.location.reload();
        window.close();
      } else {
        // If not in popup, redirect to test editor
        window.location.href = `/teacher/tests/{{ test_id }}/edit/`;
      }
    } else {
      return r.json().then(data => {
        alert("Error importing questions: " + (data.error || "Unknown error"));
      });
    }
  })
  .catch(err => {
    console.error(err);
    alert("Failed to import questions. Please try again.");
  });
}
{% endif %}

// Delete question function
function deleteQuestion(questionId) {
  if (!confirm('Are you sure you want to delete this question?\n\nThis action cannot be undone.')) {
    return;
  }

  fetch(`/questions/delete/${questionId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('‚úì Question deleted successfully!');
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to delete question'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error deleting question. Please try again.');
  });
}

// Toggle all checkboxes
function toggleAllDelete() {
  const selectAll = document.getElementById('selectAllDelete');
  const checkboxes = document.querySelectorAll('.delete-check');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateDeleteCount();
}

// Update selected count
function updateDeleteCount() {
  const checked = document.querySelectorAll('.delete-check:checked');
  const count = checked.length;
  document.getElementById('selectedCount').textContent = count;
  document.getElementById('bulkDeleteBtn').disabled = count === 0;
}

// Bulk delete selected questions
async function bulkDelete() {
  const checked = document.querySelectorAll('.delete-check:checked');
  const ids = Array.from(checked).map(cb => cb.value);

  if (ids.length === 0) {
    alert('No questions selected');
    return;
  }

  if (!confirm(`Are you sure you want to delete ${ids.length} question(s)?\n\nThis action cannot be undone.`)) {
    return;
  }

  const bulkBtn = document.getElementById('bulkDeleteBtn');
  bulkBtn.disabled = true;
  bulkBtn.textContent = 'Deleting...';

  let deleted = 0;
  let errors = [];

  for (const id of ids) {
    try {
      const response = await fetch(`/questions/delete/${id}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        deleted++;
      } else {
        errors.push(`Question ${id}: ${data.error}`);
      }
    } catch (error) {
      errors.push(`Question ${id}: Network error`);
    }
  }

  if (errors.length > 0) {
    alert(`Deleted ${deleted} question(s).\n\nErrors:\n${errors.join('\n')}`);
  } else {
    alert(`‚úì Successfully deleted ${deleted} question(s)!`);
  }

  window.location.reload();
}
</script>

{% endwith %}
{% endwith %}
{% endblock %}