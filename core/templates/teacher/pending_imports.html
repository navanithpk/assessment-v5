{% extends "teacher/teacher_base.html" %}

{% block title %}Pending PDF Imports - Lumen{% endblock %}

{% block content %}
<style>
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 30px;
}

.page-header {
  margin-bottom: 30px;
}

.page-header h1 {
  font-size: 32px;
  color: #1f2937;
  margin-bottom: 8px;
}

.page-header p {
  color: #6b7280;
  font-size: 16px;
}

.sessions-grid {
  display: grid;
  gap: 20px;
}

.session-card {
  background: white;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s;
}

.session-card:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

.session-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.session-title {
  font-size: 20px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 8px;
}

.session-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
  font-size: 14px;
  color: #6b7280;
}

.session-meta span {
  display: flex;
  align-items: center;
  gap: 6px;
}

.progress-section {
  margin: 16px 0;
}

.progress-bar-container {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s;
}

.progress-text {
  font-size: 13px;
  color: #6b7280;
}

.session-actions {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.btn-danger {
  background: #ef4444;
  color: white;
}

.btn-danger:hover {
  background: #dc2626;
}

.btn-success {
  background: #10b981;
  color: white;
}

.btn-success:hover {
  background: #059669;
}

.status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}

.status-paused {
  background: #dbeafe;
  color: #1e40af;
}

.status-in-progress {
  background: #dcfce7;
  color: #166534;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  background: white;
  border-radius: 12px;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 20px;
  color: #1f2937;
  margin-bottom: 8px;
}

.empty-state p {
  color: #6b7280;
  margin-bottom: 24px;
}
</style>

<div class="container">
  <div class="page-header">
    <h1>üìÇ Pending PDF Imports</h1>
    <p>Resume your saved import sessions</p>
  </div>

  {% if sessions %}
  <div class="sessions-grid">
    {% for session in sessions %}
    <div class="session-card">
      <div class="session-header">
        <div>
          <div class="session-title">{{ session.session_name }}</div>
          <span class="status-badge status-{{ session.status }}">{{ session.get_status_display }}</span>
        </div>
      </div>

      <div class="session-meta">
        <span>
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/><path d="M3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762z"/><path fill-rule="evenodd" d="M9.3 13.616l-3.66-1.57a1 1 0 00-.751 1.841l4.126 1.768a.997.997 0 00.787 0l7-3a1 1 0 10-.788-1.838L9.3 13.616z" clip-rule="evenodd"/>
          </svg>
          {{ session.grade.name }}
        </span>
        <span>
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
          </svg>
          {{ session.subject.name }}
        </span>
        <span>
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
          </svg>
          {{ session.year }}
        </span>
        <span>
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
          </svg>
          {{ session.created_at|date:"d-m-Y" }}
        </span>
      </div>

      <div class="progress-section">
        <div class="progress-bar-container">
          <div class="progress-bar-fill" style="width: {{ session.progress_percentage }}%"></div>
        </div>
        <div class="progress-text">
          {{ session.processed_files }} / {{ session.total_files }} files completed ({{ session.progress_percentage }}%)
        </div>
      </div>

      <div class="session-actions">
        <a href="{% url 'resume_import_session' session.id %}" class="btn btn-primary">
          ‚ñ∂Ô∏è Resume Import
        </a>

        {% if session.processed_files == session.total_files %}
        <button onclick="markComplete({{ session.id }})" class="btn btn-success">
          ‚úÖ Mark as Complete
        </button>
        {% endif %}

        <button onclick="deleteSession({{ session.id }})" class="btn btn-danger">
          üóëÔ∏è Delete
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">üì≠</div>
    <h3>No Pending Imports</h3>
    <p>You don't have any saved import sessions. Start a new import from the question library.</p>
    <a href="{% url 'import_mcq_pdf' %}" class="btn btn-primary">
      Start New Import
    </a>
  </div>
  {% endif %}
</div>

<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

const csrftoken = getCookie('csrftoken');

async function deleteSession(sessionId) {
  if (!confirm('Are you sure you want to delete this import session? This cannot be undone.')) {
    return;
  }

  try {
    const response = await fetch(`/teacher/import-sessions/${sessionId}/delete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    });

    if (response.ok) {
      alert('Session deleted successfully!');
      window.location.reload();
    } else {
      alert('Error deleting session');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error deleting session');
  }
}

async function markComplete(sessionId) {
  try {
    const response = await fetch(`/teacher/import-sessions/${sessionId}/complete/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    });

    if (response.ok) {
      alert('Session marked as complete!');
      window.location.reload();
    } else {
      alert('Error marking session as complete');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error marking session as complete');
  }
}
</script>
{% endblock %}
