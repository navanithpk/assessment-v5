{% extends "teacher/teacher_base.html" %}

{% block title %}Bulk Import Users{% endblock %}

{% block content %}
<style>
/* ‚îÄ‚îÄ Page shell: fill the viewport, no outer scroll ‚îÄ‚îÄ */
.bi-page {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 60px);
  gap: 14px;
  overflow: hidden;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.bi-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

.bi-title { font-size: 20px; font-weight: 700; color: #111827; }
.bi-subtitle { font-size: 13px; color: #6b7280; margin-top: 2px; }

/* ‚îÄ‚îÄ Tab bar ‚îÄ‚îÄ */
.bi-tabs {
  display: flex;
  gap: 0;
  background: #f3f4f6;
  border-radius: 10px;
  padding: 4px;
  flex-shrink: 0;
  width: fit-content;
}

.bi-tab {
  padding: 8px 22px;
  border-radius: 7px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  background: transparent;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.15s, color 0.15s, box-shadow 0.15s;
}

.bi-tab.active {
  background: white;
  color: #111827;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.bi-tab.active.tab-student { color: #1d4ed8; }
.bi-tab.active.tab-teacher { color: #6d28d9; }

.bi-tab.disabled-tab {
  opacity: 0.45;
  cursor: not-allowed;
}

/* ‚îÄ‚îÄ Body: two-panel layout ‚îÄ‚îÄ */
.bi-body {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 14px;
  flex: 1;
  min-height: 0;
}

/* ‚îÄ‚îÄ Shared card ‚îÄ‚îÄ */
.bi-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  border: 1px solid #f0f0f0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ Left: column reference ‚îÄ‚îÄ */
.ref-panel {
  padding: 18px;
  overflow-y: auto;
  flex: 1;
}

.ref-section-title {
  font-size: 10.5px;
  font-weight: 700;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  color: #9ca3af;
  margin: 0 0 7px 0;
}

.ref-section-title:not(:first-child) { margin-top: 14px; }

.col-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.col-item {
  display: flex;
  align-items: flex-start;
  gap: 7px;
  font-size: 12px;
  color: #374151;
  padding: 5px 7px;
  border-radius: 6px;
}

.col-item.required { background: #fef3f2; }
.col-item.optional { background: #f0fdf4; }

.col-badge {
  flex-shrink: 0;
  font-size: 9.5px;
  font-weight: 700;
  padding: 2px 5px;
  border-radius: 4px;
  margin-top: 1px;
}

.col-badge.req { background: #fee2e2; color: #dc2626; }
.col-badge.opt { background: #dcfce7; color: #16a34a; }

.col-code {
  font-family: 'Courier New', monospace;
  font-size: 11.5px;
  font-weight: 600;
  color: #4f46e5;
}

.col-desc { color: #6b7280; font-size: 11px; }

.auto-box {
  margin-top: 14px;
  background: #eff6ff;
  border: 1px solid #dbeafe;
  border-radius: 8px;
  padding: 10px 12px;
}

.auto-box-title {
  font-size: 10.5px;
  font-weight: 700;
  color: #1d4ed8;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.auto-item {
  font-size: 11.5px;
  color: #1e40af;
  padding: 2px 0;
}

.note-box {
  margin-top: 14px;
  background: #fefce8;
  border: 1px solid #fde68a;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 11.5px;
  color: #92400e;
  line-height: 1.5;
}

/* ‚îÄ‚îÄ Right: upload panel ‚îÄ‚îÄ */
.upload-panel {
  padding: 26px 30px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 18px;
  flex: 1;
}

/* Messages */
.msg-list { display: flex; flex-direction: column; gap: 7px; }
.msg {
  padding: 9px 13px;
  border-radius: 8px;
  font-size: 13px;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}
.msg.error   { background: #fef2f2; border: 1px solid #fecaca; color: #b91c1c; }
.msg.success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #15803d; }
.msg.warning { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }

/* Steps */
.steps {
  display: flex;
  align-items: center;
}

.step {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: #9ca3af;
}

.step-num {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #6b7280;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10.5px;
  font-weight: 700;
  flex-shrink: 0;
}

.step.active .step-num { background: #4f46e5; color: white; }
.step.active { color: #4f46e5; font-weight: 600; }

.step-line { flex: 1; height: 1px; background: #e5e7eb; margin: 0 8px; min-width: 20px; }

/* Template download row */
.template-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
}

.template-row-icon { font-size: 22px; }

.template-row-text { flex: 1; }
.template-row-text strong { font-size: 13px; color: #1e293b; }
.template-row-text span { display: block; font-size: 11.5px; color: #64748b; margin-top: 1px; }

.btn-template {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: white;
  color: #4f46e5;
  border: 1.5px solid #c7d2fe;
  border-radius: 8px;
  font-size: 12.5px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  white-space: nowrap;
  transition: background 0.15s, border-color 0.15s;
}

.btn-template:hover { background: #eef2ff; border-color: #818cf8; }

/* Drop zone */
.drop-zone {
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  padding: 28px 20px;
  text-align: center;
  cursor: pointer;
  transition: border-color 0.2s, background 0.2s;
  background: #fafafa;
  position: relative;
}

.drop-zone:hover,
.drop-zone.drag-over {
  border-color: #4f46e5;
  background: #f5f3ff;
}

.drop-zone input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  width: 100%;
  height: 100%;
}

.drop-icon { font-size: 32px; line-height: 1; margin-bottom: 8px; }
.drop-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 3px; }
.drop-hint  { font-size: 11.5px; color: #9ca3af; }

.file-chosen {
  margin-top: 8px;
  font-size: 13px;
  color: #4f46e5;
  font-weight: 500;
  display: none;
}

/* Submit button */
.btn-preview {
  width: 100%;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14.5px;
  font-weight: 600;
  cursor: pointer;
  transition: opacity 0.2s, transform 0.15s, box-shadow 0.15s;
  box-shadow: 0 4px 14px rgba(102,126,234,0.3);
}

.btn-preview:hover {
  opacity: 0.93;
  transform: translateY(-1px);
  box-shadow: 0 6px 18px rgba(102,126,234,0.4);
}

.btn-preview:disabled {
  opacity: 0.45;
  cursor: not-allowed;
  transform: none;
}

.format-note { text-align: center; font-size: 12px; color: #9ca3af; }

/* ‚îÄ‚îÄ Tab pane visibility ‚îÄ‚îÄ */
.tab-pane { display: none; }
.tab-pane.active { display: contents; }
</style>

<div class="bi-page">

  <!-- Header -->
  <div class="bi-header">
    <div>
      <div class="bi-title">üì• Bulk Import Users</div>
      <div class="bi-subtitle">Import students or teachers from a CSV or Excel file</div>
    </div>

    <!-- Tab switcher -->
    <div class="bi-tabs">
      <button class="bi-tab tab-student active" onclick="switchTab('student')" id="tab-student">
        üë®‚Äçüéì Students
      </button>
      <button class="bi-tab tab-teacher {% if not is_school_admin %}disabled-tab{% endif %}"
              onclick="switchTab('teacher')" id="tab-teacher">
        üë®‚Äçüè´ Teachers
      </button>
    </div>
  </div>

  <!-- Body: left reference + right upload -->
  <div class="bi-body">

    <!-- ‚îÄ‚îÄ LEFT: Column Reference ‚îÄ‚îÄ -->
    <div class="bi-card">
      <div class="ref-panel">

        <!-- Student reference -->
        <div class="tab-pane active" id="ref-student">
          <div class="ref-section-title">Required columns</div>
          <ul class="col-list">
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">full_name</div><div class="col-desc">Student's full name</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">email</div><div class="col-desc">Email ‚Äî also used as login username</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">password</div><div class="col-desc">Initial password (min 8 chars)</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">grade</div><div class="col-desc">Grade / class (e.g. "AS Level")</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">division</div><div class="col-desc">Section (e.g. "A", "B")</div></div>
            </li>
          </ul>

          <div class="ref-section-title">Optional columns</div>
          <ul class="col-list">
            <li class="col-item optional">
              <span class="col-badge opt">OPT</span>
              <div><div class="col-code">roll_number</div><div class="col-desc">Auto-assigned if blank</div></div>
            </li>
            <li class="col-item optional">
              <span class="col-badge opt">OPT</span>
              <div><div class="col-code">admission_id</div><div class="col-desc">Auto-assigned if blank</div></div>
            </li>
          </ul>

          <div class="auto-box">
            <div class="auto-box-title">‚ú¶ Auto-assigned when blank</div>
            <div class="auto-item">‚úì Roll number (sequential per class)</div>
            <div class="auto-item">‚úì Admission ID (ADM{year}###)</div>
          </div>
        </div>

        <!-- Teacher reference -->
        <div class="tab-pane" id="ref-teacher">
          <div class="ref-section-title">Required columns</div>
          <ul class="col-list">
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">full_name</div><div class="col-desc">Teacher's full name</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">email</div><div class="col-desc">Email ‚Äî also used as login username</div></div>
            </li>
            <li class="col-item required">
              <span class="col-badge req">REQ</span>
              <div><div class="col-code">password</div><div class="col-desc">Initial password (min 8 chars)</div></div>
            </li>
          </ul>

          <div class="ref-section-title">Optional columns</div>
          <ul class="col-list">
            <li class="col-item optional">
              <span class="col-badge opt">OPT</span>
              <div><div class="col-code">subject</div><div class="col-desc">Subject specialization</div></div>
            </li>
          </ul>

          <div class="note-box">
            ‚ö†Ô∏è Only <strong>School Admins</strong> can import teacher accounts.
          </div>
        </div>

      </div>
    </div>

    <!-- ‚îÄ‚îÄ RIGHT: Upload Panel ‚îÄ‚îÄ -->
    <div class="bi-card">
      <div class="upload-panel">

        <!-- Messages -->
        {% if messages %}
        <div class="msg-list">
          {% for message in messages %}
          <div class="msg {{ message.tags }}">
            {% if message.tags == 'error' %}‚ö†Ô∏è{% elif message.tags == 'success' %}‚úÖ{% else %}‚ÑπÔ∏è{% endif %}
            {{ message }}
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Steps indicator -->
        <div class="steps">
          <div class="step active">
            <div class="step-num">1</div>
            Upload file
          </div>
          <div class="step-line"></div>
          <div class="step">
            <div class="step-num">2</div>
            Preview
          </div>
          <div class="step-line"></div>
          <div class="step">
            <div class="step-num">3</div>
            Import
          </div>
        </div>

        <!-- Template download row (changes per tab) -->
        <div class="template-row" id="templateRow-student">
          <div class="template-row-icon">üìÑ</div>
          <div class="template-row-text">
            <strong>Student Import Template</strong>
            <span>CSV with required columns pre-filled and sample rows</span>
          </div>
          <a href="{% url 'download_student_template' %}" class="btn-template">
            ‚¨á Download CSV
          </a>
        </div>

        <div class="template-row" id="templateRow-teacher" style="display:none;">
          <div class="template-row-icon">üìÑ</div>
          <div class="template-row-text">
            <strong>Teacher Import Template</strong>
            <span>CSV with required columns pre-filled and sample rows</span>
          </div>
          <a href="{% url 'download_teacher_template' %}" class="btn-template">
            ‚¨á Download CSV
          </a>
        </div>

        <!-- Upload form -->
        <form method="post" enctype="multipart/form-data" id="importForm">
          {% csrf_token %}
          <input type="hidden" name="import_type" id="importTypeInput" value="student">

          <div class="drop-zone" id="dropZone">
            <input type="file" name="excel_file" id="excel_file"
                   accept=".xlsx,.xls,.csv" required
                   onchange="fileChosen(this)">
            <div class="drop-icon">üìä</div>
            <div class="drop-title" id="dropTitle">Drop your Student CSV/Excel here</div>
            <div class="drop-hint">.xlsx / .xls / .csv ¬∑ max 10 MB</div>
            <div class="file-chosen" id="fileChosenLabel"></div>
          </div>

          <button type="submit" name="preview" class="btn-preview" id="previewBtn" disabled>
            üëÅ Preview Data ‚Üí
          </button>
        </form>

        <div class="format-note">
          Download the template above ‚Äî it shows the exact column names and sample data.
        </div>

      </div>
    </div>

  </div>
</div>

<script>
const isSchoolAdmin = {{ is_school_admin|yesno:"true,false" }};

function switchTab(role) {
  if (role === 'teacher' && !isSchoolAdmin) {
    alert('Only school administrators can import teacher accounts.');
    return;
  }

  // Tab buttons
  document.getElementById('tab-student').classList.toggle('active', role === 'student');
  document.getElementById('tab-teacher').classList.toggle('active', role === 'teacher');

  // Left reference panels
  document.getElementById('ref-student').classList.toggle('active', role === 'student');
  document.getElementById('ref-teacher').classList.toggle('active', role === 'teacher');

  // Template download rows
  document.getElementById('templateRow-student').style.display = role === 'student' ? '' : 'none';
  document.getElementById('templateRow-teacher').style.display = role === 'teacher' ? '' : 'none';

  // Hidden import_type field
  document.getElementById('importTypeInput').value = role;

  // Drop zone label
  const label = role === 'student' ? 'Drop your Student CSV/Excel here'
                                    : 'Drop your Teacher CSV/Excel here';
  document.getElementById('dropTitle').textContent = label;

  // Reset file input
  document.getElementById('excel_file').value = '';
  document.getElementById('fileChosenLabel').style.display = 'none';
  document.getElementById('previewBtn').disabled = true;
}

function fileChosen(input) {
  if (input.files && input.files[0]) {
    const el = document.getElementById('fileChosenLabel');
    el.textContent = 'üìé ' + input.files[0].name;
    el.style.display = 'block';
    document.getElementById('previewBtn').disabled = false;
  }
}

// Drag-and-drop
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('excel_file');

dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('drag-over');
});
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    fileChosen(fileInput);
  }
});
</script>

{% endblock %}
