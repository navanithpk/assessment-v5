<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ test.title }} - Assessment</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prosemirror-view/1.31.3/prosemirror-view.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      overflow-x: hidden;
    }

    /* ===================== TOP BAR ===================== */
    .top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
    }

    .test-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .test-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .test-meta-badge {
      background: var(--gray-100);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .timer-display {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .timer {
      font-size: 32px;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      color: var(--gray-900);
      min-width: 140px;
      text-align: center;
      padding: 8px 20px;
      background: var(--gray-100);
      border-radius: 12px;
      transition: all 0.3s;
    }

    .timer.warning {
      background: #fef3c7;
      color: #92400e;
      animation: pulse-warning 1s infinite;
    }

    .timer.danger {
      background: #fee2e2;
      color: #991b1b;
      animation: pulse-danger 0.5s infinite;
    }

    @keyframes pulse-warning {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes pulse-danger {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .submit-btn {
      padding: 12px 28px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .submit-btn:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }

    /* ===================== LAYOUT ===================== */
    .main-layout {
      display: flex;
      margin-top: 70px;
      min-height: calc(100vh - 70px);
    }

    /* ===================== SIDEBAR NAVIGATION ===================== */
    .question-nav {
      width: 280px;
      background: white;
      border-right: 1px solid var(--gray-200);
      padding: 24px;
      position: fixed;
      height: calc(100vh - 70px);
      overflow-y: auto;
    }

    .nav-header {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .nav-item {
      aspect-ratio: 1;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .nav-item:hover {
      border-color: var(--primary);
      background: var(--gray-50);
    }

    .nav-item.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .nav-item.answered {
      background: #dcfce7;
      border-color: var(--success);
      color: var(--success);
    }

    .nav-item.answered::after {
      content: '‚úì';
      position: absolute;
      top: 2px;
      right: 2px;
      font-size: 10px;
      background: var(--success);
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-summary {
      margin-top: 24px;
      padding: 16px;
      background: var(--gray-50);
      border-radius: 12px;
    }

    .progress-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .progress-item:last-child {
      margin-bottom: 0;
    }

    .progress-label {
      color: var(--gray-600);
    }

    .progress-value {
      font-weight: 700;
    }

    /* ===================== QUESTION AREA ===================== */
    .question-area {
      flex: 1;
      margin-left: 280px;
      padding: 40px;
    }

    .question-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--gray-200);
    }

    .question-number-badge {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
      background: #dbeafe;
      padding: 10px 20px;
      border-radius: 10px;
    }

    .question-marks {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-600);
      background: var(--gray-100);
      padding: 10px 20px;
      border-radius: 10px;
    }

    .question-content {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 32px;
      font-size: 16px;
      line-height: 1.8;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .question-content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 16px 0;
    }

    .answer-section {
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .answer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .answer-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .save-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--gray-100);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--gray-600);
    }

    .save-indicator.saving {
      background: #dbeafe;
      color: var(--primary);
    }

    .save-indicator.saved {
      background: #dcfce7;
      color: var(--success);
    }

    /* ===================== EDITOR ===================== */
    .editor-wrapper {
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      background: white;
      transition: all 0.2s;
    }

    .editor-wrapper:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .editor-toolbar {
      display: flex;
      gap: 4px;
      padding: 12px;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
      border-radius: 12px 12px 0 0;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      background: white;
      border: 1px solid var(--gray-300);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
      min-width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
    }

    .toolbar-btn:hover {
      background: var(--gray-100);
      border-color: var(--gray-400);
    }

    .toolbar-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .toolbar-divider {
      width: 1px;
      background: var(--gray-300);
      margin: 0 8px;
    }

    .ProseMirror {
      padding: 24px;
      min-height: 300px;
      outline: none;
      font-size: 15px;
      line-height: 1.8;
      color: var(--gray-900);
    }

    .ProseMirror p {
      margin-bottom: 12px;
    }

    .ProseMirror table {
      border-collapse: collapse;
      margin: 16px 0;
      width: 100%;
    }

    .ProseMirror th,
    .ProseMirror td {
      border: 1px solid var(--gray-300);
      padding: 10px 14px;
    }

    .ProseMirror th {
      background: var(--gray-100);
      font-weight: 600;
    }

    .ProseMirror img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    /* ===================== NAVIGATION BUTTONS ===================== */
    .question-navigation {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }

    .nav-btn {
      flex: 1;
      padding: 14px 24px;
      border: 2px solid var(--gray-300);
      background: white;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .nav-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-btn.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .nav-btn.primary:hover {
      background: var(--primary-dark);
    }

    /* ===================== MODAL ===================== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--gray-900);
    }

    .modal-text {
      font-size: 16px;
      color: var(--gray-600);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.cancel {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .modal-btn.cancel:hover {
      background: var(--gray-300);
    }

    .modal-btn.confirm {
      background: var(--success);
      color: white;
    }

    .modal-btn.confirm:hover {
      background: #059669;
    }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 1024px) {
      .question-nav {
        width: 240px;
      }

      .question-area {
        margin-left: 240px;
      }
    }

    @media (max-width: 768px) {
      .top-bar {
        padding: 0 16px;
        height: auto;
        flex-direction: column;
        padding: 16px;
        gap: 12px;
      }

      .test-info {
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        width: 100%;
      }

      .timer {
        font-size: 24px;
      }

      .question-nav {
        display: none;
      }

      .question-area {
        margin-left: 0;
        padding: 20px;
      }

      .main-layout {
        margin-top: 120px;
      }
    }
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="test-info">
      <div class="test-title">{{ test.title }}</div>
      <div class="test-meta-badge">{{ test_questions|length }} Questions</div>
      <div class="test-meta-badge">{{ total_marks }} Marks</div>
    </div>

    <div class="timer-display">
      <div class="timer" id="timer">{{ time_remaining }}</div>
      <button class="submit-btn" onclick="showSubmitModal()">
        ‚úì Submit Test
      </button>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="main-layout">
    <!-- SIDEBAR NAVIGATION -->
    <div class="question-nav">
      <div class="nav-header">Questions</div>
      <div class="nav-grid" id="questionNavGrid">
        {% for tq in test_questions %}
        <button 
          class="nav-item {% if forloop.first %}active{% endif %}" 
          data-question="{{ forloop.counter }}"
          onclick="goToQuestion({{ forloop.counter }})"
        >
          {{ forloop.counter }}
        </button>
        {% endfor %}
      </div>

      <div class="progress-summary">
        <div class="progress-item">
          <span class="progress-label">Answered:</span>
          <span class="progress-value" id="answeredCount">0/{{ test_questions|length }}</span>
        </div>
        <div class="progress-item">
          <span class="progress-label">Remaining:</span>
          <span class="progress-value" id="remainingCount">{{ test_questions|length }}</span>
        </div>
        <div class="progress-item" style="padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--gray-300);">
          <span class="progress-label">Progress:</span>
          <span class="progress-value" id="progressPercent">0%</span>
        </div>
      </div>
    </div>

    <!-- QUESTION AREA -->
    <div class="question-area">
      <div class="question-container">
        {% for tq in test_questions %}
        <div class="question-wrapper" id="question-{{ forloop.counter }}" style="{% if not forloop.first %}display: none;{% endif %}">
          <div class="question-header">
            <div class="question-number-badge">Question {{ forloop.counter }} of {{ test_questions|length }}</div>
            <div class="question-marks">{{ tq.question.marks }} mark{{ tq.question.marks|pluralize }}</div>
          </div>

          <div class="question-content">
            {{ tq.question.question_text|safe }}
          </div>

          <div class="answer-section">
            <div class="answer-header">
              <div class="answer-title">Your Answer</div>
              <div class="save-indicator" id="saveIndicator-{{ forloop.counter }}">
                <span>üíæ</span>
                <span id="saveText-{{ forloop.counter }}">Auto-save enabled</span>
              </div>
            </div>

            <div class="editor-wrapper">
              <div class="editor-toolbar">
                <button type="button" class="toolbar-btn" data-command="bold" title="Bold">
                  <strong>B</strong>
                </button>
                <button type="button" class="toolbar-btn" data-command="italic" title="Italic">
                  <em>I</em>
                </button>
                <button type="button" class="toolbar-btn" data-command="underline" title="Underline">
                  <u>U</u>
                </button>
                <button type="button" class="toolbar-btn" data-command="subscript" title="Subscript">
                  X<sub>2</sub>
                </button>
                <button type="button" class="toolbar-btn" data-command="superscript" title="Superscript">
                  X<sup>2</sup>
                </button>
                <div class="toolbar-divider"></div>
                <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                  ‚Ä¢
                </button>
                <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                  1.
                </button>
                <div class="toolbar-divider"></div>
                <button type="button" class="toolbar-btn" onclick="insertTableIntoEditor({{ forloop.counter }})" title="Insert Table">
                  ‚äû
                </button>
              </div>
              <div 
                class="ProseMirror" 
                id="editor-{{ forloop.counter }}" 
                contenteditable="true"
                data-question-id="{{ tq.question.id }}"
                data-question-number="{{ forloop.counter }}"
              >{{ tq.saved_answer|default:""|safe }}</div>
            </div>
          </div>

          <div class="question-navigation">
            {% if not forloop.first %}
            <button class="nav-btn" onclick="previousQuestion()">
              ‚Üê Previous
            </button>
            {% endif %}

            {% if not forloop.last %}
            <button class="nav-btn primary" onclick="nextQuestion()">
              Next ‚Üí
            </button>
            {% else %}
            <button class="nav-btn primary" onclick="showSubmitModal()">
              ‚úì Submit Test
            </button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- SUBMIT CONFIRMATION MODAL -->
  <div class="modal" id="submitModal">
    <div class="modal-content">
      <div class="modal-icon">üìù</div>
      <h2 class="modal-title">Submit Test?</h2>
      <p class="modal-text">
        Are you sure you want to submit your test? You won't be able to make changes after submission.
        <br><br>
        <strong id="submitSummary"></strong>
      </p>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="closeSubmitModal()">
          Cancel
        </button>
        <button class="modal-btn confirm" onclick="submitTest()">
          Submit Now
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===================== INITIALIZATION =====================
    const testId = {{ test.id }};
    const totalQuestions = {{ test_questions|length }};
    let currentQuestion = 1;
    let timeRemaining = {{ time_remaining_seconds }};
    let answers = {};
    let autoSaveTimers = {};
    let hasChanged = {};

    // Load saved answers
    {% for tq in test_questions %}
    answers[{{ forloop.counter }}] = {{ tq.saved_answer|default:"''"|safe|escapejs }};
    {% endfor %}

    // ===================== TIMER =====================
    function updateTimer() {
      if (timeRemaining <= 0) {
        autoSubmitTest();
        return;
      }

      const hours = Math.floor(timeRemaining / 3600);
      const minutes = Math.floor((timeRemaining % 3600) / 60);
      const seconds = timeRemaining % 60;

      const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      const timerEl = document.getElementById('timer');
      timerEl.textContent = display;

      // Warning states
      if (timeRemaining <= 300) { // 5 minutes
        timerEl.classList.add('danger');
      } else if (timeRemaining <= 600) { // 10 minutes
        timerEl.classList.add('warning');
        timerEl.classList.remove('danger');
      } else {
        timerEl.classList.remove('warning', 'danger');
      }

      timeRemaining--;
    }

    setInterval(updateTimer, 1000);
    updateTimer();

    // ===================== NAVIGATION =====================
    function goToQuestion(num) {
      // Hide all questions
      document.querySelectorAll('.question-wrapper').forEach(q => {
        q.style.display = 'none';
      });

      // Show target question
      document.getElementById(`question-${num}`).style.display = 'block';

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`.nav-item[data-question="${num}"]`).classList.add('active');

      currentQuestion = num;

      // Scroll to top
      window.scrollTo(0, 0);
    }

    function nextQuestion() {
      if (currentQuestion < totalQuestions) {
        goToQuestion(currentQuestion + 1);
      }
    }

    function previousQuestion() {
      if (currentQuestion > 1) {
        goToQuestion(currentQuestion - 1);
      }
    }

    // ===================== EDITOR FUNCTIONALITY =====================
    document.querySelectorAll('.toolbar-btn[data-command]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const command = btn.dataset.command;
        document.execCommand(command, false, null);
        updateToolbarState();
      });
    });

    function updateToolbarState() {
      document.querySelectorAll('.toolbar-btn[data-command]').forEach(btn => {
        const command = btn.dataset.command;
        if (document.queryCommandState(command)) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    function insertTableIntoEditor(questionNum) {
      const rows = prompt('Number of rows:', '3');
      const cols = prompt('Number of columns:', '3');
      
      if (rows && cols) {
        let html = '<table><tbody>';
        for (let i = 0; i < parseInt(rows); i++) {
          html += '<tr>';
          for (let j = 0; j < parseInt(cols); j++) {
            html += i === 0 ? '<th>Header</th>' : '<td>Cell</td>';
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
        
        const editor = document.getElementById(`editor-${questionNum}`);
        editor.focus();
        document.execCommand('insertHTML', false, html);
      }
    }

    // ===================== AUTO-SAVE =====================
    document.querySelectorAll('.ProseMirror').forEach(editor => {
      const questionNum = parseInt(editor.dataset.questionNumber);
      const questionId = editor.dataset.questionId;

      editor.addEventListener('input', () => {
        hasChanged[questionNum] = true;
        
        // Clear existing timer
        if (autoSaveTimers[questionNum]) {
          clearTimeout(autoSaveTimers[questionNum]);
        }

        // Set new timer for 5 seconds
        autoSaveTimers[questionNum] = setTimeout(() => {
          if (hasChanged[questionNum]) {
            saveAnswer(questionNum, questionId, editor.innerHTML);
          }
        }, 5000);
      });

      // Track selection changes for toolbar
      editor.addEventListener('mouseup', updateToolbarState);
      editor.addEventListener('keyup', updateToolbarState);
    });

    function saveAnswer(questionNum, questionId, content) {
      const indicator = document.getElementById(`saveIndicator-${questionNum}`);
      const text = document.getElementById(`saveText-${questionNum}`);

      indicator.classList.add('saving');
      text.textContent = 'Saving...';

      fetch(`/student/tests/{{ test.id }}/save-answer/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          question_id: questionId,
          answer_text: content
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'ok') {
          answers[questionNum] = content;
          hasChanged[questionNum] = false;
          
          indicator.classList.remove('saving');
          indicator.classList.add('saved');
          text.textContent = 'Saved ‚úì';

          // Update nav item
          const navItem = document.querySelector(`.nav-item[data-question="${questionNum}"]`);
          if (content.trim() && content !== '<br>') {
            navItem.classList.add('answered');
          } else {
            navItem.classList.remove('answered');
          }

          updateProgress();

          setTimeout(() => {
            indicator.classList.remove('saved');
            text.textContent = 'Auto-save enabled';
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Save error:', error);
        indicator.classList.remove('saving');
        text.textContent = 'Save failed';
      });
    }

    // ===================== PROGRESS TRACKING =====================
    function updateProgress() {
      const answeredItems = document.querySelectorAll('.nav-item.answered').length;
      const remaining = totalQuestions - answeredItems;
      const percent = Math.round((answeredItems / totalQuestions) * 100);

      document.getElementById('answeredCount').textContent = `${answeredItems}/${totalQuestions}`;
      document.getElementById('remainingCount').textContent = remaining;
      document.getElementById('progressPercent').textContent = `${percent}%`;
    }

    // ===================== SUBMISSION =====================
    function showSubmitModal() {
      const answeredCount = document.querySelectorAll('.nav-item.answered').length;
      const unanswered = totalQuestions - answeredCount;

      let summary = `You have answered ${answeredCount} out of ${totalQuestions} questions.`;
      if (unanswered > 0) {
        summary += `<br>${unanswered} question${unanswered > 1 ? 's' : ''} ${unanswered > 1 ? 'are' : 'is'} still unanswered.`;
      }

      document.getElementById('submitSummary').innerHTML = summary;
      document.getElementById('submitModal').classList.add('active');
    }

    function closeSubmitModal() {
      document.getElementById('submitModal').classList.remove('active');
    }

    function submitTest() {
      // Save all pending changes first
      document.querySelectorAll('.ProseMirror').forEach(editor => {
        const questionNum = parseInt(editor.dataset.questionNumber);
        const questionId = editor.dataset.questionId;
        if (hasChanged[questionNum]) {
          saveAnswer(questionNum, questionId, editor.innerHTML);
        }
      });

      // Submit after brief delay to ensure saves complete
      setTimeout(() => {
        fetch(`/student/tests/{{ test.id }}/submit/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok') {
            window.location.href = data.redirect;
          }
        });
      }, 500);
    }

    function autoSubmitTest() {
      alert('Time is up! Your test will be submitted automatically.');
      submitTest();
    }

    // ===================== PREVENT ACCIDENTAL EXIT =====================
    window.addEventListener('beforeunload', (e) => {
      e.preventDefault();
      e.returnValue = '';
      return '';
    });

    // Initialize progress
    updateProgress();
  </script>
</body>
</html>