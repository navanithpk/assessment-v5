{% extends "student/student_base.html" %}

{% block title %}Take Test â€” {{ test.title }}{% endblock %}

{% block content %}
<style>
/* ==========================================================
   STUDENT TEST â€” No-Scroll Design
   Tested breakpoints: 1920Ã—1080, 1366Ã—768, 1280Ã—800,
   1024Ã—768, 768Ã—1024, 800Ã—1280 (Android tablet),
   375Ã—812 (Mobile)
   ========================================================== */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* Cover the entire viewport; base-template nav is hidden behind */
.app-shell {
  position: fixed;
  inset: 0;
  z-index: 9000;
  display: flex;
  flex-direction: column;
  background: #f1f5f9;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  overflow: hidden;
}

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.test-header {
  flex-shrink: 0;
  height: 56px;
  min-height: 56px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 100;
}

.sidebar-toggle {
  display: none;
  width: 36px;
  height: 36px;
  min-width: 36px;
  background: rgba(255,255,255,0.15);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 17px;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

.test-title {
  flex: 1;
  font-size: 15px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.save-pill {
  font-size: 11px;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 12px;
  background: rgba(255,255,255,0.1);
  display: none;
  white-space: nowrap;
}
.save-pill.saving { display: block; color: rgba(255,255,255,0.85); }
.save-pill.saved  { display: block; color: #86efac; }

.progress-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
}

.progress-track {
  width: 60px;
  height: 5px;
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: white;
  border-radius: 3px;
  width: 0%;
  transition: width 0.3s ease;
}

.timer-pill {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  background: rgba(255,255,255,0.15);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.timer-pill.warning {
  background: #ef4444;
  animation: timerPulse 1s infinite;
}

@keyframes timerPulse {
  0%, 100% { opacity: 1; }
  50%       { opacity: 0.65; }
}

/* â”€â”€ App Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-body {
  flex: 1;
  display: flex;
  min-height: 0;
  overflow: hidden;
  position: relative;
}

/* â”€â”€ Sidebar overlay (mobile/tablet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.48);
  z-index: 155;
}
.sidebar-overlay.active { display: block; }

/* â”€â”€ Left Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 190px;
  min-width: 190px;
  flex-shrink: 0;
  background: white;
  border-right: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: transform 0.25s ease;
  z-index: 160;
}

.sidebar-header {
  padding: 13px 14px 9px;
  font-size: 10px;
  font-weight: 800;
  color: #64748b;
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid #e2e8f0;
  flex-shrink: 0;
}

.question-nav-grid {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(38px, 1fr));
  gap: 6px;
  align-content: start;
}

/* Nav buttons â€” no aspect-ratio for Android compat */
.question-nav-btn {
  width: 38px;
  height: 38px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 12px;
  font-weight: 700;
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  flex-shrink: 0;
  transition: border-color 0.15s, background 0.15s, color 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.question-nav-btn:hover  { border-color: #667eea; color: #667eea; }
.question-nav-btn.current {
  border-color: #667eea;
  background: #667eea;
  color: white;
  box-shadow: 0 2px 8px rgba(102,126,234,0.35);
}
.question-nav-btn.attempted {
  background: #ede9fe;
  border-color: #8b5cf6;
  color: #4c1d95;
}
.question-nav-btn.flagged {
  background: #fef3c7;
  border-color: #f59e0b;
  color: #78350f;
}
.question-nav-btn.flagged::after {
  content: 'ğŸš©';
  position: absolute;
  top: -7px;
  right: -7px;
  font-size: 10px;
  line-height: 1;
}

/* Legend */
.nav-legend {
  padding: 10px 12px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 7px;
  font-size: 10px;
  color: #64748b;
}

.legend-dot {
  width: 14px;
  height: 14px;
  min-width: 14px;
  border-radius: 4px;
  border: 2px solid;
}
.legend-dot.unattempted { background: white;   border-color: #e2e8f0; }
.legend-dot.attempted   { background: #ede9fe; border-color: #8b5cf6; }
.legend-dot.flagged     { background: #fef3c7; border-color: #f59e0b; }

/* â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  overflow: hidden;
}

/* Question scroll area â€” only inner scrolling, page never scrolls */
.question-scroll {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 20px;
  scroll-behavior: smooth;
}

/* â”€â”€ Question Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.question-card {
  background: white;
  border-radius: 14px;
  padding: 26px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.07);
  min-height: 180px;
}

.question-number-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 6px 13px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 16px;
}

.marks-badge {
  background: rgba(255,255,255,0.25);
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 11px;
}

.question-content {
  font-size: 16px;
  line-height: 1.8;
  color: #1e293b;
  margin-bottom: 18px;
}

.question-content img {
  max-width: 100%;
  height: auto;
  border-radius: 10px;
  margin: 10px 0;
  display: block;
}

/* Sub-questions */
.sub-question {
  margin-left: 16px;
  margin-bottom: 20px;
  padding-left: 14px;
  border-left: 3px solid #c7d2fe;
}
.sub-question .question-number-badge {
  background: linear-gradient(135deg, #818cf8, #6366f1);
  font-size: 12px;
  padding: 5px 11px;
}

.sub-sub-question {
  margin-left: 32px;
  margin-bottom: 16px;
  padding-left: 12px;
  border-left: 2px solid #e0e7ff;
}
.sub-sub-question .question-number-badge {
  background: linear-gradient(135deg, #a5b4fc, #818cf8);
  font-size: 12px;
  padding: 4px 10px;
}

/* MCQ */
.mcq-options {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 16px;
}

.mcq-option {
  padding: 15px 18px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  background: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  text-align: center;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
  -webkit-tap-highlight-color: transparent;
  transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
}

.mcq-option:hover      { border-color: #667eea; background: #f5f3ff; }
.mcq-option.selected   {
  border-color: #667eea;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 4px 12px rgba(102,126,234,0.3);
}
.mcq-option.selected::after {
  content: 'âœ“';
  position: absolute;
  top: 7px;
  right: 11px;
  font-size: 15px;
  font-weight: bold;
}

.mcq-clear-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  color: #475569;
  display: none;
  transition: all 0.2s;
}
.mcq-clear-btn.visible { display: inline-block; }
.mcq-clear-btn:hover   { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }

/* Answer field */
.answer-field { margin-top: 18px; }
.answer-label {
  font-size: 13px;
  font-weight: 700;
  color: #475569;
  margin-bottom: 8px;
  display: block;
}
.answer-textarea {
  width: 100%;
  min-height: 120px;
  padding: 13px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 15px;
  line-height: 1.6;
  font-family: inherit;
  resize: vertical;
  background: #fafafa;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.answer-textarea:focus {
  outline: none;
  border-color: #667eea;
  background: white;
  box-shadow: 0 0 0 3px rgba(102,126,234,0.12);
}

/* Structured answers */
.structured-answer-form {
  margin-top: 18px;
  border-top: 2px solid #e2e8f0;
  padding-top: 18px;
}
.structured-answer-form h4 {
  font-size: 14px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 12px;
}
.answer-part {
  margin-bottom: 14px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.answer-part:hover, .answer-part:focus-within { border-color: #667eea; }
.answer-part-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 9px 13px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}
.answer-part-label  { font-weight: 700; font-size: 13px; }
.answer-part-marks  { background: rgba(255,255,255,0.2); padding: 3px 7px; border-radius: 9px; font-size: 11px; }
.answer-part.nested { margin-left: 18px; border-left: 3px solid #818cf8; }
.answer-part.nested .answer-part-header { background: linear-gradient(135deg, #818cf8, #6366f1); }
.answer-part.deeply-nested { margin-left: 36px; border-left: 3px solid #a5b4fc; }
.answer-part.deeply-nested .answer-part-header { background: linear-gradient(135deg, #a5b4fc, #818cf8); }

.editor-toolbar {
  display: flex;
  gap: 3px;
  padding: 5px 9px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  flex-wrap: wrap;
}
.toolbar-btn {
  padding: 4px 8px;
  border: 1px solid #e2e8f0;
  background: white;
  border-radius: 5px;
  cursor: pointer;
  font-size: 12px;
  color: #475569;
  transition: all 0.15s;
  line-height: 1.4;
}
.toolbar-btn:hover { background: #667eea; color: white; border-color: #667eea; }

.answer-part-editor {
  min-height: 90px;
  padding: 11px 13px;
  font-size: 14px;
  line-height: 1.6;
  outline: none;
}
.answer-part-editor:empty::before {
  content: attr(data-placeholder);
  color: #94a3b8;
  font-style: italic;
  pointer-events: none;
}

/* Flag button */
.flag-btn {
  margin-top: 16px;
  padding: 9px 16px;
  background: white;
  border: 2px solid #fbbf24;
  border-radius: 8px;
  color: #78350f;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-tap-highlight-color: transparent;
}
.flag-btn.flagged { background: #fbbf24; color: white; }
.flag-btn:hover   { background: #fbbf24; color: white; }

/* Structured question container */
.structured-question-container {
  position: relative;
  display: inline-block;
  margin-top: 14px;
  max-width: 100%;
}

/* â”€â”€ Bottom Navigation Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bottom-nav {
  flex-shrink: 0;
  height: 62px;
  min-height: 62px;
  background: white;
  border-top: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 12px;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.06);
  z-index: 50;
}

.nav-btn {
  padding: 10px 22px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  transition: box-shadow 0.2s, transform 0.15s;
  -webkit-tap-highlight-color: transparent;
}

.nav-btn.secondary {
  background: #f1f5f9;
  color: #475569;
  border: 1px solid #e2e8f0;
}
.nav-btn.secondary:hover:not(:disabled) { background: #e2e8f0; }

.nav-btn.primary {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 3px 10px rgba(102,126,234,0.3);
}
.nav-btn.primary:hover:not(:disabled) {
  box-shadow: 0 5px 14px rgba(102,126,234,0.4);
  transform: translateY(-1px);
}

.nav-btn.success {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  box-shadow: 0 3px 10px rgba(16,185,129,0.3);
}
.nav-btn.success:hover:not(:disabled) {
  box-shadow: 0 5px 14px rgba(16,185,129,0.4);
  transform: translateY(-1px);
}

.nav-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

.nav-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}
.nav-center-label {
  font-size: 13px;
  font-weight: 700;
  color: #1e293b;
}
.nav-center-sub {
  font-size: 10px;
  color: #94a3b8;
}

/* â”€â”€ Tablet & Mobile (sidebar drawer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1023px) {
  .sidebar-toggle { display: flex; }

  .sidebar {
    position: fixed;
    left: 0;
    top: 56px;
    height: calc(100% - 56px);
    width: 220px;
    min-width: 220px;
    transform: translateX(-100%);
    box-shadow: 4px 0 20px rgba(0,0,0,0.15);
    z-index: 160;
  }

  .sidebar.open { transform: translateX(0); }

  .question-scroll { padding: 14px; }
  .question-card   { padding: 18px; border-radius: 12px; }
  .mcq-options     { grid-template-columns: 1fr; }
  .test-title      { font-size: 13px; }
  .timer-pill      { font-size: 12px; padding: 5px 10px; }
  .progress-pill   { display: none; }
}

/* Portrait tablet / large phone */
@media (max-width: 768px) {
  .question-card   { padding: 15px; }
  .question-content { font-size: 15px; }
  .bottom-nav      { padding: 0 12px; gap: 8px; }
  .nav-btn         { padding: 9px 14px; font-size: 13px; }
  .nav-center-label { font-size: 12px; }
  .nav-center-sub  { display: none; }
}

/* â”€â”€ Instructions Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.inst-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.92);
  z-index: 10000;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px;
}
.inst-card {
  background: white;
  border-radius: 20px;
  max-width: 780px;
  width: 100%;
  padding: 36px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.4);
  margin: auto;
}
.inst-title { text-align: center; margin-bottom: 26px; }
.inst-title h1 { font-size: 26px; color: #1e293b; margin-bottom: 8px; }
.inst-title p  { color: #64748b; font-size: 14px; }
.inst-box {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 14px;
  padding: 26px;
  color: white;
  margin-bottom: 22px;
}
.inst-box h2 {
  font-size: 18px;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 9px;
}
.inst-list { list-style: none; font-size: 14px; line-height: 1.7; }
.inst-list li {
  padding: 9px 0;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  display: flex;
  gap: 10px;
}
.inst-list li:last-child { border-bottom: none; }
.inst-warn {
  background: #fff7ed;
  border-left: 4px solid #f59e0b;
  padding: 14px 18px;
  border-radius: 10px;
  margin-bottom: 22px;
  font-size: 13px;
  color: #92400e;
  line-height: 1.6;
}
.start-btn {
  display: block;
  width: 100%;
  max-width: 260px;
  margin: 0 auto;
  padding: 15px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(102,126,234,0.35);
  transition: box-shadow 0.2s, transform 0.15s;
}
.start-btn:hover { box-shadow: 0 10px 30px rgba(102,126,234,0.45); transform: translateY(-2px); }

/* Print */
@media print {
  .test-header, .sidebar, .bottom-nav, .save-pill { display: none !important; }
  .app-shell { position: static; height: auto; overflow: visible; }
  .app-body  { overflow: visible; height: auto; }
  .question-scroll { overflow: visible; }
}
</style>

<div class="app-shell" id="appShell">

  <!-- â”€â”€ Instructions Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="inst-overlay" id="instructionsOverlay">
    <div class="inst-card">
      <div class="inst-title">
        <h1>{{ test.title }}</h1>
        <p>Read the instructions carefully before starting</p>
      </div>

      <div class="inst-box">
        <h2>
          <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Test Instructions
        </h2>
        <ul class="inst-list">
          <li><span>ğŸ“±</span><span><strong>Fullscreen:</strong> The test runs in fullscreen. Please remain in fullscreen throughout.</span></li>
          {% if test.duration_minutes %}
          <li><span>â±ï¸</span><span><strong>Time Limit:</strong> You have {{ test.duration_minutes }} minutes. The timer starts when you click Begin.</span></li>
          {% endif %}
          <li><span>ğŸ’¾</span><span><strong>Auto-Save:</strong> Your answers save automatically. Watch for the "âœ“ Saved" indicator in the header.</span></li>
          <li><span>ğŸ§­</span><span><strong>Navigate:</strong> Tap the â˜° menu to jump questions. Use Previous / Next at the bottom. Arrow keys also work.</span></li>
          <li><span>ğŸš©</span><span><strong>Flag:</strong> Mark questions for review. Flagged questions show in yellow in the navigator.</span></li>
          <li><span>âœ…</span><span><strong>Submit:</strong> Press "Submit Test âœ“" on the last question, or via the button that appears there.</span></li>
        </ul>
      </div>

      <div class="inst-warn">
        <strong>âš ï¸ Important:</strong> Once you click "Begin Test" the timer starts. Do not refresh or navigate away â€” your answers are saved automatically.
      </div>

      <button class="start-btn" onclick="startTest()">ğŸš€ Begin Test</button>
    </div>
  </div>

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="test-header">
    <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" aria-label="Toggle question list">â˜°</button>
    <div class="test-title">{{ test.title }}</div>
    <div class="header-right">
      <span class="save-pill" id="savePill"></span>
      <div class="progress-pill">
        <span id="progressText">1 / {{ test.questions.count }}</span>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill"></div>
        </div>
      </div>
      {% if test.duration_minutes %}
      <div class="timer-pill" id="timerDisplay">
        â± <span id="timeRemaining">{{ test.duration_minutes }}:00</span>
      </div>
      {% endif %}
    </div>
  </header>

  <!-- â”€â”€ App Body â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="app-body">

    <!-- Sidebar overlay backdrop (mobile/tablet) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Left Sidebar: Question Navigator -->
    <nav class="sidebar" id="sidebar" aria-label="Question navigation">
      <div class="sidebar-header">Questions</div>
      <div class="question-nav-grid" id="questionNavGrid">
        <!-- Rendered by JavaScript -->
      </div>
      <div class="nav-legend">
        <div class="legend-item"><div class="legend-dot unattempted"></div><span>Unattempted</span></div>
        <div class="legend-item"><div class="legend-dot attempted"></div><span>Attempted</span></div>
        <div class="legend-item"><div class="legend-dot flagged"></div><span>Flagged</span></div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

      <!-- Question content â€” only this region scrolls internally -->
      <div class="question-scroll" id="questionScroll">
        <div class="question-card" id="questionCard">
          <!-- Content rendered by JavaScript after user clicks Begin -->
        </div>
      </div>

      <!-- Bottom nav bar â€” fixed height, always visible -->
      <div class="bottom-nav">
        <button class="nav-btn secondary" id="prevBtn" onclick="previousPage()" disabled>â† Prev</button>

        <div class="nav-center">
          <span class="nav-center-label" id="currentQuestionIndicator">Question 1 of {{ test.questions.count }}</span>
          <span class="nav-center-sub">â† â†’ arrow keys to navigate</span>
        </div>

        <button class="nav-btn primary" id="nextBtn" onclick="nextPage()">Next â†’</button>
      </div>

    </main>
  </div>
</div>

<script>
// =====================================================
// FULLSCREEN
// =====================================================
function enterFullscreen() {
  const el = document.documentElement;
  try {
    if      (el.requestFullscreen)       el.requestFullscreen();
    else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    else if (el.msRequestFullscreen)     el.msRequestFullscreen();
  } catch (e) { /* silently ignore â€“ browser policy */ }
}

document.addEventListener('DOMContentLoaded', function() {
  enterFullscreen();
  document.addEventListener('click', enterFullscreen, { once: true });
});

document.addEventListener('fullscreenchange', function() {
  if (!document.fullscreenElement) {
    if (confirm('Please stay in fullscreen mode during the test. Return to fullscreen?')) {
      enterFullscreen();
    }
  }
});

// =====================================================
// SIDEBAR TOGGLE (tablet / mobile)
// =====================================================
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}

// =====================================================
// KEYBOARD NAVIGATION
// =====================================================
document.addEventListener('keydown', function(e) {
  const active = document.activeElement;
  const isTyping = active.tagName === 'INPUT' || active.tagName === 'TEXTAREA' || active.isContentEditable;
  if (isTyping) return;

  if (e.key === 'ArrowLeft'  || e.keyCode === 37) { e.preventDefault(); if (!document.getElementById('prevBtn').disabled) previousPage(); }
  if (e.key === 'ArrowRight' || e.keyCode === 39) { e.preventDefault(); nextPage(); }
  if (e.key === 'f' || e.key === 'F')             { e.preventDefault(); toggleFlag(); }
});

// =====================================================
// CSRF HELPER
// =====================================================
function getCookie(name) {
  let v = null;
  if (document.cookie) {
    document.cookie.split(';').forEach(function(c) {
      c = c.trim();
      if (c.startsWith(name + '=')) v = decodeURIComponent(c.slice(name.length + 1));
    });
  }
  return v;
}

// =====================================================
// DATA & STATE
// =====================================================
const csrftoken = getCookie('csrftoken');
const testData  = {{ test_data|safe }};
const testId    = {{ test.id }};

let currentPageIndex = 0;
const answers         = {};
const flaggedQuestions = new Set();
const questionTimers   = {};
let pageStartTime      = null;

// =====================================================
// TIME TRACKING (per question analytics)
// =====================================================
function recordPageTime() {
  if (pageStartTime !== null) {
    const elapsed = Math.round((Date.now() - pageStartTime) / 1000);
    const page = testData.pages[currentPageIndex];
    if (page && page.questions) {
      page.questions.forEach(function(q) {
        if (q.id) questionTimers[q.id] = (questionTimers[q.id] || 0) + elapsed;
      });
    }
  }
  pageStartTime = Date.now();
}

// =====================================================
// LOAD SAVED ANSWERS
// =====================================================
async function loadSavedAnswers() {
  try {
    const r = await fetch('/student/tests/' + testId + '/answers/', {
      headers: { 'X-CSRFToken': csrftoken }
    });
    if (r.ok) {
      const d = await r.json();
      Object.assign(answers, d.answers || {});
    }
  } catch (e) { console.error('Load answers error:', e); }
}

// =====================================================
// QUESTION NAVIGATION GRID
// =====================================================
function renderQuestionNav() {
  const grid = document.getElementById('questionNavGrid');
  grid.innerHTML = '';
  testData.pages.forEach(function(page, i) {
    const btn = document.createElement('button');
    btn.className = 'question-nav-btn';
    btn.textContent = i + 1;
    btn.setAttribute('aria-label', 'Question ' + (i + 1));
    btn.onclick = function() { navigateToQuestion(i); closeSidebar(); };

    if (i === currentPageIndex)          btn.classList.add('current');
    else if (flaggedQuestions.has(i))    btn.classList.add('flagged');
    else if (isQuestionAttempted(i))     btn.classList.add('attempted');

    grid.appendChild(btn);
  });
}

function isQuestionAttempted(idx) {
  const page = testData.pages[idx];
  if (!page || !page.questions) return false;
  return page.questions.some(function(q) { return hasAnswerForQuestion(q); });
}

function hasAnswerForQuestion(q) {
  if (q.answerId && answers[q.answerId]) return true;
  if (q.isStructured) {
    if (q.answerParts && q.answerParts.length > 0) {
      return q.answerParts.some(function(p) {
        const k = 'structured-' + q.id + '-' + p.partId;
        return answers[k] && answers[k].trim();
      });
    }
    const k = 'structured-' + q.id + '-main';
    return !!(answers[k] && answers[k].trim());
  }
  if (q.hasAnswerSpaces && q.answerSpaces) {
    return q.answerSpaces.some(function(s) {
      const k = 'space-' + q.id + '-' + s.id;
      return answers[k] && answers[k].trim();
    });
  }
  if (q.subQuestions) {
    return q.subQuestions.some(function(s) { return hasAnswerForQuestion(s); });
  }
  return false;
}

function navigateToQuestion(i) {
  recordPageTime();
  saveCurrentPageAnswers();
  currentPageIndex = i;
  renderPage(i);
  scrollQuestionToTop();
}

function scrollQuestionToTop() {
  const qs = document.getElementById('questionScroll');
  if (qs) qs.scrollTop = 0;
}

function toggleFlag() {
  if (flaggedQuestions.has(currentPageIndex)) {
    flaggedQuestions.delete(currentPageIndex);
  } else {
    flaggedQuestions.add(currentPageIndex);
  }
  renderQuestionNav();
  updateFlagButton();
}

function updateFlagButton() {
  const btn = document.getElementById('flagBtn');
  if (!btn) return;
  const f = flaggedQuestions.has(currentPageIndex);
  btn.classList.toggle('flagged', f);
  btn.textContent = f ? 'ğŸš© Flagged' : 'ğŸš© Flag for Review';
}

// =====================================================
// PAGE RENDERING
// =====================================================
function renderPage(idx) {
  const page      = testData.pages[idx];
  const container = document.getElementById('questionCard');

  let html = '';
  page.questions.forEach(function(q) { html += renderQuestion(q); });
  html += '<button class="flag-btn" id="flagBtn" onclick="toggleFlag()">ğŸš© Flag for Review</button>';

  container.innerHTML = html;
  restoreAnswers();

  // Render overlay answer spaces after DOM settles
  setTimeout(function() {
    page.questions.forEach(function(q) {
      if (q.hasAnswerSpaces && q.answerSpaces) renderAnswerSpaces(q);
    });
  }, 120);

  updateProgress();
  updateNavButtons();
  updateFlagButton();
  renderQuestionNav();
}

function renderQuestion(q, level) {
  level = level || 0;
  const cls = level === 0 ? 'main-question' : level === 1 ? 'sub-question' : 'sub-sub-question';

  let html = '<div class="' + cls + '">';
  html += '<div class="question-number-badge">' + q.number + '<span class="marks-badge">' + q.marks + 'm</span></div>';

  if (q.isStructured && q.answerParts) {
    html += '<div class="question-content">' + q.content + '</div>';
    html += renderStructuredAnswerForm(q);
  } else if (q.hasAnswerSpaces && q.answerSpaces) {
    html += '<div class="structured-question-container" style="position:relative;display:inline-block;margin-top:14px;">'
          + '<div style="position:relative;display:inline-block;">' + q.content + '</div>'
          + '<div id="answer-spaces-container-' + q.id + '" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></div>'
          + '</div>';
  } else {
    html += '<div class="question-content">' + q.content + '</div>';
  }

  if (!q.isStructured && !q.hasAnswerSpaces && q.answerId) {
    const saved = answers[q.answerId] || '';
    const isMCQ = q.questionType === 'mcq' || (q.content && q.content.indexOf('mcq-options') !== -1);

    if (isMCQ) {
      html += '<div class="answer-field"><label class="answer-label">Select your answer:</label>'
            + '<div class="mcq-options" id="mcq-' + q.answerId + '">'
            + ['A','B','C','D'].map(function(opt) {
                return '<div class="mcq-option ' + (saved === opt ? 'selected' : '') + '" onclick="selectMCQOption(\'' + q.answerId + '\', \'' + opt + '\')">' + opt + '</div>';
              }).join('')
            + '</div>'
            + '<button class="mcq-clear-btn ' + (saved ? 'visible' : '') + '" id="clear-' + q.answerId + '" onclick="clearMCQSelection(\'' + q.answerId + '\')">âœ• Clear</button>'
            + '</div>';
    } else {
      html += '<div class="answer-field">'
            + '<label class="answer-label">Your Answer:</label>'
            + '<textarea class="answer-textarea" id="' + q.answerId + '" data-question-id="' + q.answerId + '" placeholder="Type your answer here..." oninput="handleAnswerInput(\'' + q.answerId + '\')">' + saved + '</textarea>'
            + '</div>';
    }
  }

  if (q.subQuestions) {
    q.subQuestions.forEach(function(sub) { html += renderQuestion(sub, level + 1); });
  }

  html += '</div>';
  return html;
}

function renderStructuredAnswerForm(q) {
  if (!q.answerParts || q.answerParts.length === 0) {
    const k    = 'structured-' + q.id + '-main';
    const saved = answers[k] || '';
    return '<div class="structured-answer-form"><h4>âœï¸ Your Answer</h4>'
         + '<div class="answer-part">'
         + '<div class="answer-part-header"><span class="answer-part-label">Answer</span><span class="answer-part-marks">' + q.marks + ' marks</span></div>'
         + '<div class="editor-toolbar">'
         + '<button class="toolbar-btn" onclick="formatText(\'bold\')"><b>B</b></button>'
         + '<button class="toolbar-btn" onclick="formatText(\'italic\')"><i>I</i></button>'
         + '<button class="toolbar-btn" onclick="formatText(\'underline\')"><u>U</u></button>'
         + '<button class="toolbar-btn" onclick="formatText(\'subscript\')">Xâ‚‚</button>'
         + '<button class="toolbar-btn" onclick="formatText(\'superscript\')">XÂ²</button>'
         + '</div>'
         + '<div class="answer-part-editor" contenteditable="true" id="' + k + '" data-answer-key="' + k + '" data-placeholder="Type your answer here..." oninput="handleStructuredInput(\'' + k + '\')">' + saved + '</div>'
         + '</div></div>';
  }

  let html = '<div class="structured-answer-form"><h4>âœï¸ Your Answers</h4>';
  q.answerParts.forEach(function(part) {
    const k     = 'structured-' + q.id + '-' + part.partId;
    const saved  = answers[k] || '';
    const nl     = part.level || 0;
    const nc     = nl === 1 ? 'nested' : nl >= 2 ? 'deeply-nested' : '';
    html += '<div class="answer-part ' + nc + '">'
          + '<div class="answer-part-header"><span class="answer-part-label">' + part.label + '</span><span class="answer-part-marks">' + (part.marks || 0) + ' mark' + (part.marks !== 1 ? 's' : '') + '</span></div>'
          + '<div class="editor-toolbar">'
          + '<button class="toolbar-btn" onclick="formatText(\'bold\')"><b>B</b></button>'
          + '<button class="toolbar-btn" onclick="formatText(\'italic\')"><i>I</i></button>'
          + '<button class="toolbar-btn" onclick="formatText(\'underline\')"><u>U</u></button>'
          + '<button class="toolbar-btn" onclick="formatText(\'subscript\')">Xâ‚‚</button>'
          + '<button class="toolbar-btn" onclick="formatText(\'superscript\')">XÂ²</button>'
          + '</div>'
          + '<div class="answer-part-editor" contenteditable="true" id="' + k + '" data-answer-key="' + k + '" data-placeholder="' + (part.hint || 'Answer for ' + part.label + 'â€¦') + '" oninput="handleStructuredInput(\'' + k + '\')">' + saved + '</div>'
          + '</div>';
  });
  html += '</div>';
  return html;
}

function formatText(cmd) { document.execCommand(cmd, false, null); }

function handleStructuredInput(k) {
  const el = document.getElementById(k);
  if (el) { answers[k] = el.innerHTML; renderQuestionNav(); autoSave(); }
}

function selectMCQOption(qId, opt) {
  const c = document.getElementById('mcq-' + qId);
  if (!c) return;
  c.querySelectorAll('.mcq-option').forEach(function(o) { o.classList.remove('selected'); });
  if (event && event.currentTarget) event.currentTarget.classList.add('selected');
  else c.querySelector('[onclick*="\'' + opt + '\'"]').classList.add('selected');
  answers[qId] = opt;
  const clearBtn = document.getElementById('clear-' + qId);
  if (clearBtn) clearBtn.classList.add('visible');
  renderQuestionNav();
  autoSave();
}

function clearMCQSelection(qId) {
  const c = document.getElementById('mcq-' + qId);
  if (c) c.querySelectorAll('.mcq-option').forEach(function(o) { o.classList.remove('selected'); });
  answers[qId] = '';
  const clearBtn = document.getElementById('clear-' + qId);
  if (clearBtn) clearBtn.classList.remove('visible');
  renderQuestionNav();
  autoSave();
}

// =====================================================
// ANSWER SPACES (legacy overlay style)
// =====================================================
function renderAnswerSpaces(q) {
  const containerEl = document.getElementById('answer-spaces-container-' + q.id);
  if (!containerEl) return;
  const parent = containerEl.closest('.structured-question-container');
  if (!parent) return;
  const imgEl = parent.querySelector('img');
  if (!imgEl) return;
  if (!imgEl.complete) { imgEl.onload = function() { renderAnswerSpaces(q); }; return; }

  const imgW = imgEl.offsetWidth;
  const imgH = imgEl.offsetHeight;

  q.answerSpaces.forEach(function(space) {
    const answerKey = 'space-' + q.id + '-' + space.id;
    const div = document.createElement('div');
    div.id              = 'answer-space-' + q.id + '-' + space.id;
    div.contentEditable = 'true';
    div.className       = 'answer-space-editor';
    div.dataset.spaceId   = space.id;
    div.dataset.questionId = q.id;
    div.dataset.answerKey  = answerKey;
    div.dataset.spaceType  = space.type || 'long_answer';
    div.dataset.placeholder = 'Answerâ€¦ (' + (space.marks || 0) + 'm)';

    Object.assign(div.style, {
      position:     'absolute',
      left:         ((space.x / imgW) * 100) + '%',
      top:          ((space.y / imgH) * 100) + '%',
      width:        ((space.width  / imgW) * 100) + '%',
      height:       ((space.height / imgH) * 100) + '%',
      border:       '2px solid #667eea',
      borderRadius: '6px',
      background:   'rgba(255,255,255,0.95)',
      padding:      '6px',
      overflow:     'auto',
      pointerEvents:'auto',
      fontSize:     '13px',
      lineHeight:   '1.5',
      fontFamily:   'inherit',
      boxSizing:    'border-box',
    });

    if (answers[answerKey]) div.innerHTML = answers[answerKey];

    div.addEventListener('focus', function() { this.style.borderColor = '#4f46e5'; this.style.background = 'white'; });
    div.addEventListener('blur',  function() { this.style.borderColor = '#667eea'; this.style.background = 'rgba(255,255,255,0.95)'; });
    div.addEventListener('input', function() { answers[answerKey] = this.innerHTML; renderQuestionNav(); autoSave(); });
    div.addEventListener('paste', function(e) {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
    });

    containerEl.appendChild(div);
  });

  if (!document.getElementById('answer-space-styles')) {
    const s = document.createElement('style');
    s.id = 'answer-space-styles';
    s.textContent = '.answer-space-editor:empty::before { content: attr(data-placeholder); color: #94a3b8; font-style: italic; } .answer-space-editor:focus:empty::before { content: ""; }';
    document.head.appendChild(s);
  }
}

// =====================================================
// SAVE CURRENT PAGE ANSWERS
// =====================================================
function saveCurrentPageAnswers() {
  const page = testData.pages[currentPageIndex];
  if (page && page.questions) {
    page.questions.forEach(function(q) {
      if (q.isStructured) {
        const keys = (q.answerParts && q.answerParts.length > 0)
          ? q.answerParts.map(function(p) { return 'structured-' + q.id + '-' + p.partId; })
          : ['structured-' + q.id + '-main'];
        keys.forEach(function(k) { const el = document.getElementById(k); if (el) answers[k] = el.innerHTML; });
      }
      if (q.hasAnswerSpaces && q.answerSpaces) {
        q.answerSpaces.forEach(function(s) {
          const el = document.getElementById('answer-space-' + q.id + '-' + s.id);
          if (el) answers['space-' + q.id + '-' + s.id] = el.innerHTML;
        });
      }
    });
  }
  document.querySelectorAll('textarea[data-question-id]').forEach(function(t) {
    answers[t.dataset.questionId] = t.value;
  });
  document.querySelectorAll('.answer-part-editor[data-answer-key]').forEach(function(e) {
    answers[e.dataset.answerKey] = e.innerHTML;
  });
}

function restoreAnswers() {
  Object.keys(answers).forEach(function(k) {
    const t = document.getElementById(k);
    if (t && t.tagName === 'TEXTAREA') t.value = answers[k];
  });
}

function handleAnswerInput(qId) {
  const t = document.getElementById(qId);
  if (t) { answers[qId] = t.value; renderQuestionNav(); autoSave(); }
}

// =====================================================
// PROGRESS & NAV BUTTONS
// =====================================================
function updateProgress() {
  const pct = ((currentPageIndex + 1) / testData.pages.length) * 100;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent  = (currentPageIndex + 1) + ' / ' + testData.pages.length;
}

function updateNavButtons() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const ind     = document.getElementById('currentQuestionIndicator');

  prevBtn.disabled = (currentPageIndex === 0);
  if (ind) ind.textContent = 'Question ' + (currentPageIndex + 1) + ' of ' + testData.pages.length;

  if (currentPageIndex === testData.pages.length - 1) {
    nextBtn.textContent  = 'Submit Test âœ“';
    nextBtn.className    = 'nav-btn success';
  } else {
    nextBtn.textContent  = 'Next â†’';
    nextBtn.className    = 'nav-btn primary';
  }
}

function nextPage() {
  recordPageTime();
  saveCurrentPageAnswers();
  if (currentPageIndex < testData.pages.length - 1) {
    currentPageIndex++;
    renderPage(currentPageIndex);
    scrollQuestionToTop();
  } else {
    submitTest();
  }
}

function previousPage() {
  recordPageTime();
  saveCurrentPageAnswers();
  if (currentPageIndex > 0) {
    currentPageIndex--;
    renderPage(currentPageIndex);
    scrollQuestionToTop();
  }
}

// =====================================================
// SUBMIT TEST
// =====================================================
async function submitTest() {
  if (!confirm('Are you sure you want to submit your test? You cannot make changes after submission.')) return;

  recordPageTime();
  saveCurrentPageAnswers();

  alert('Processing your answers. This may take a momentâ€¦');

  for (const page of testData.pages) {
    for (const q of page.questions) {
      if (q.hasAnswerSpaces) { await saveRasterizedAnswers(); break; }
    }
  }

  try {
    const r = await fetch('/student/tests/' + testId + '/submit/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ answers: answers, submitted: true, questionTimers: questionTimers })
    });
    if (r.ok) {
      alert('Test submitted successfully!');
      window.location.href = '{% url "student_tests_list" %}';
    } else {
      alert('Error submitting test. Please try again.');
    }
  } catch (e) {
    console.error('Submit error:', e);
    alert('Error submitting test. Please try again.');
  }
}

// =====================================================
// AUTO-SAVE
// =====================================================
let saveTimeout;
async function autoSave() {
  clearTimeout(saveTimeout);
  const pill = document.getElementById('savePill');
  pill.textContent = 'Savingâ€¦';
  pill.className   = 'save-pill saving';

  saveTimeout = setTimeout(async function() {
    try {
      const r = await fetch('/student/tests/' + testId + '/autosave/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ answers: answers, currentPage: currentPageIndex, questionTimers: questionTimers })
      });
      if (r.ok) {
        pill.textContent = 'âœ“ Saved';
        pill.className   = 'save-pill saved';
        setTimeout(function() { pill.textContent = ''; pill.className = 'save-pill'; }, 2200);
      } else {
        pill.textContent = ''; pill.className = 'save-pill';
      }
    } catch (e) {
      pill.textContent = ''; pill.className = 'save-pill';
    }
  }, 1000);
}

// =====================================================
// TIMER
// =====================================================
{% if test.duration_minutes %}
let timeLeft     = {{ test.duration_minutes }} * 60;
let timerStarted = false;

function updateTimer() {
  const h = Math.floor(timeLeft / 3600);
  const m = Math.floor((timeLeft % 3600) / 60);
  const s = timeLeft % 60;
  const display = h > 0
    ? h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0')
    : m + ':' + String(s).padStart(2, '0');

  document.getElementById('timeRemaining').textContent = display;
  if (timeLeft <= 300 && timeLeft > 0) document.getElementById('timerDisplay').classList.add('warning');

  if (timeLeft > 0) { timeLeft--; setTimeout(updateTimer, 1000); }
  else { alert('Time is up! Your test will be submitted automatically.'); submitTest(); }
}

function startTimer() {
  if (!timerStarted) { timerStarted = true; updateTimer(); }
}
{% endif %}

// =====================================================
// INITIALISE
// =====================================================
(async function() { await loadSavedAnswers(); })();

async function startTest() {
  enterFullscreen();
  document.getElementById('instructionsOverlay').style.display = 'none';
  {% if test.duration_minutes %}startTimer();{% endif %}
  renderPage(0);
  pageStartTime = Date.now();
}

// Warn before leaving
window.addEventListener('beforeunload', function(e) { e.preventDefault(); e.returnValue = ''; return ''; });

// =====================================================
// RASTERIZATION (answer-space overlay â†’ image)
// =====================================================
async function rasterizeAnswerSpaces(qId) {
  const q = testData.pages.reduce(function(acc, p) { return acc || p.questions.find(function(x) { return x.id === qId; }); }, null);
  if (!q || !q.hasAnswerSpaces) return null;
  const rasterized = [];

  for (const space of q.answerSpaces) {
    const iframe = document.getElementById('answer-space-' + qId + '-' + space.id);
    if (iframe) {
      try {
        const doc    = iframe.contentDocument || iframe.contentWindow.document;
        const editor = doc.querySelector('[contenteditable="true"]');
        if (editor && window.html2canvas) {
          const tmp = document.createElement('div');
          Object.assign(tmp.style, { width: space.width + 'px', height: space.height + 'px', padding: '8px', background: 'white', overflow: 'hidden' });
          tmp.innerHTML = editor.innerHTML;
          document.body.appendChild(tmp);
          const canvas = await html2canvas(tmp, { backgroundColor: '#ffffff', scale: 2 });
          rasterized.push({ spaceId: space.id, x: space.x, y: space.y, width: space.width, height: space.height, imageData: canvas.toDataURL('image/png') });
          document.body.removeChild(tmp);
        }
      } catch (e) { console.error('Rasterize error:', e); }
    }
  }
  return rasterized;
}

async function saveRasterizedAnswers() {
  const page = testData.pages[currentPageIndex];
  if (!page || !page.questions) return;
  for (const q of page.questions) {
    if (q.hasAnswerSpaces) {
      const rasterized = await rasterizeAnswerSpaces(q.id);
      if (rasterized) {
        rasterized.forEach(function(s) { answers['space-' + q.id + '-' + s.spaceId + '-raster'] = s.imageData; });
      }
    }
  }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

{% endblock %}
