{% extends "teacher/teacher_base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}

<style>
.welcome-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 16px;
  padding: 40px;
  margin-bottom: 30px;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
}

.welcome-header h1 {
  margin: 0 0 8px 0;
  font-size: 32px;
}

.welcome-header p {
  margin: 0;
  opacity: 0.9;
  font-size: 16px;
}

.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin-bottom: 30px;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s, box-shadow 0.2s;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.card-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.card h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: #1f2937;
}

.card p {
  color: #6b7280;
  margin: 0 0 20px 0;
  font-size: 14px;
  line-height: 1.6;
}

.card-btn {
  display: inline-block;
  padding: 10px 20px;
  background: #2563eb;
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  transition: background 0.2s;
}

.card-btn:hover {
  background: #1d4ed8;
}

.quick-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  border-radius: 14px;
  padding: 24px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.stat-value {
  font-size: 36px;
  font-weight: 700;
  color: #2563eb;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 14px;
  color: #6b7280;
  font-weight: 500;
}

.todo-widget {
  background: white;
  border-radius: 16px;
  padding: 28px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  margin-bottom: 30px;
}

.todo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.todo-header h2 {
  margin: 0;
  font-size: 22px;
  color: #1f2937;
}

.todo-badge {
  background: #ef4444;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
}

.todo-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.todo-item {
  padding: 16px;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  gap: 12px;
  align-items: start;
}

.todo-item:last-child {
  border-bottom: none;
}

.todo-item:hover {
  background: #f9fafb;
}

.todo-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.todo-content {
  flex: 1;
}

.todo-title {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 4px;
  font-size: 14px;
}

.todo-description {
  font-size: 13px;
  color: #6b7280;
}

.todo-empty {
  text-align: center;
  padding: 40px 20px;
  color: #9ca3af;
}

.todo-empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
}

.ai-tag-card {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.ai-tag-card .card-icon {
  color: white;
  opacity: 0.9;
}

.ai-tag-card h3 {
  color: white;
}

.ai-tag-card p {
  color: rgba(255, 255, 255, 0.9);
}

.ai-tag-card .card-btn {
  background: white;
  color: #d97706;
}

.ai-tag-card .card-btn:hover {
  background: #f3f4f6;
}

.ai-tag-card .stat-badge {
  display: inline-block;
  background: rgba(255, 255, 255, 0.2);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 12px;
}

.progress-container {
  margin-top: 16px;
  display: none;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.progress-fill {
  height: 100%;
  background: white;
  width: 0%;
  transition: width 0.3s;
}

.progress-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
  text-align: center;
}
</style>

<div class="welcome-header">
  <h1>üëã Welcome back, {{ request.user.first_name|default:request.user.username }}!</h1>
  <p>{{ school.name }}</p>
</div>

<!-- To-Do List Widget -->
{% if pending_tasks %}
<div class="todo-widget">
  <div class="todo-header">
    <h2>üìã Pending Tasks</h2>
    <span class="todo-badge">{{ pending_tasks|length }}</span>
  </div>

  <ul class="todo-list">
    {% for task in pending_tasks %}
    <li class="todo-item" onclick="window.location.href='{% url 'edit_question' task.question_id %}'">
      <div class="todo-icon">{{ task.icon }}</div>
      <div class="todo-content">
        <div class="todo-title">{{ task.title }}</div>
        <div class="todo-description">{{ task.description }}</div>
      </div>
    </li>
    {% endfor %}
  </ul>
</div>
{% else %}
<div class="todo-widget">
  <div class="todo-header">
    <h2>üìã Pending Tasks</h2>
  </div>
  <div class="todo-empty">
    <div class="todo-empty-icon">‚ú®</div>
    <div>All caught up! No pending tasks.</div>
  </div>
</div>
{% endif %}

<div class="dashboard-grid">
  {% if untagged_questions_count > 0 %}
  <div class="card ai-tag-card">
    <div class="card-icon">ü§ñ</div>
    <div class="stat-badge">{{ untagged_questions_count }}</div>
    <h3>Untagged Questions</h3>
    <p>Questions without topic or learning objective tags. Use AI to automatically tag them all at once.</p>
    <a href="{% url 'untagged_questions' %}" class="card-btn" id="bulkTagBtn" style="text-decoration: none; display: inline-block;">
      ü§ñ Manage & Tag Questions
    </a>
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">Processing...</div>
    </div>
  </div>
  {% endif %}

  <div class="card">
    <div class="card-icon">üìù</div>
    <h3>Create Test</h3>
    <p>Build a new assessment with questions from your library or create new ones.</p>
    <a href="{% url 'create_test' %}" class="card-btn">Create New Test</a>
  </div>

  <div class="card">
    <div class="card-icon">üìö</div>
    <h3>Question Library</h3>
    <p>Browse, search, and manage all your questions in one place.</p>
    <a href="{% url 'question_library' %}" class="card-btn">View Questions</a>
  </div>

  <div class="card">
    <div class="card-icon">üë•</div>
    <h3>Manage Users</h3>
    <p>Create and manage teacher and student profiles for your school.</p>
    <a href="{% url 'manage_users' %}" class="card-btn">Manage Profiles</a>
  </div>

  <div class="card">
    <div class="card-icon">üéì</div>
    <h3>Class Groups</h3>
    <p>Organize students into groups for easier test assignment.</p>
    <a href="{% url 'manage_class_groups' %}" class="card-btn">Manage Groups</a>
  </div>
</div>

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

async function bulkAITag() {
  const btn = document.getElementById('bulkTagBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');

  if (!confirm('This will use AI to automatically tag all untagged questions with topics and learning objectives. This may take several minutes. Continue?')) {
    return;
  }

  // Disable button and show progress
  btn.disabled = true;
  btn.innerHTML = 'ü§ñ Tagging in progress...';
  progressContainer.style.display = 'block';

  try {
    const response = await fetch('/teacher/bulk-ai-tag/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      }
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const {value, done} = await reader.read();
      if (done) break;

      const chunk = decoder.decode(value);
      const lines = chunk.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const data = JSON.parse(line.substring(6));

            if (data.progress !== undefined) {
              const percent = (data.progress / data.total) * 100;
              progressFill.style.width = percent + '%';
              progressText.textContent = `Tagged ${data.progress} of ${data.total} questions...`;
            }

            if (data.complete) {
              progressText.textContent = `‚úÖ Successfully tagged ${data.total} questions!`;
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            }

            if (data.error) {
              progressText.textContent = '‚ùå Error: ' + data.error;
              btn.disabled = false;
              btn.innerHTML = 'ü§ñ AI Tag All Questions';
            }
          } catch (e) {
            console.error('Error parsing SSE data:', e);
          }
        }
      }
    }
  } catch (error) {
    console.error('Error:', error);
    progressText.textContent = '‚ùå Error: ' + error.message;
    btn.disabled = false;
    btn.innerHTML = 'ü§ñ AI Tag All Questions';
  }
}
</script>

{% endblock %}