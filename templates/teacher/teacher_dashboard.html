{% extends "teacher/teacher_base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<style>
/* ‚îÄ‚îÄ Page shell: fill content area, no outer scroll ‚îÄ‚îÄ */
.db-page {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 40px); /* main has 20px padding top+bottom */
  gap: 14px;
  overflow: hidden;
}

/* ‚îÄ‚îÄ Top: compact welcome bar ‚îÄ‚îÄ */
.db-header {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: white;
  border-radius: 12px;
  padding: 14px 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  border: 1px solid #f0f0f0;
  gap: 16px;
}

.db-welcome {
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 0;
}

.db-welcome-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.db-welcome-text { min-width: 0; }

.db-welcome-name {
  font-size: 16px;
  font-weight: 700;
  color: #111827;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.db-welcome-school {
  font-size: 12px;
  color: #6b7280;
  margin-top: 1px;
}

/* Quick stat pills on the right of the header */
.db-stats {
  display: flex;
  gap: 10px;
  flex-shrink: 0;
}

.db-stat {
  display: flex;
  align-items: center;
  gap: 7px;
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 7px 14px;
}

.db-stat-icon { font-size: 16px; }

.db-stat-val {
  font-size: 16px;
  font-weight: 700;
  color: #111827;
  line-height: 1;
}

.db-stat-lbl {
  font-size: 11px;
  color: #6b7280;
  line-height: 1;
  margin-top: 2px;
}

/* ‚îÄ‚îÄ Body: left tasks + right actions ‚îÄ‚îÄ */
.db-body {
  flex: 1;
  min-height: 0;
  display: flex;        /* flex so children get a true constrained height */
  gap: 14px;
}

.db-card {
  flex: 0 0 300px;      /* tasks panel: fixed width */
}

/* ‚îÄ‚îÄ Shared card shell ‚îÄ‚îÄ */
.db-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  border: 1px solid #f0f0f0;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* ‚îÄ‚îÄ Left: Pending Tasks ‚îÄ‚îÄ */
.tasks-head {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 16px;
  border-bottom: 1px solid #f0f0f0;
}

.tasks-title {
  font-size: 14px;
  font-weight: 700;
  color: #111827;
}

.tasks-badge {
  background: #ef4444;
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 10px;
}

.tasks-badge.clear {
  background: #dcfce7;
  color: #15803d;
}

.tasks-scroll {
  flex: 1;
  overflow-y: auto;
}

.task-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 11px 16px;
  border-bottom: 1px solid #f9fafb;
  cursor: pointer;
  transition: background 0.15s;
}

.task-item:last-child { border-bottom: none; }
.task-item:hover { background: #f8fafc; }

.task-icon {
  font-size: 16px;
  flex-shrink: 0;
  margin-top: 1px;
}

.task-title {
  font-size: 12.5px;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 2px;
}

.task-desc {
  font-size: 11.5px;
  color: #6b7280;
}

.tasks-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
  color: #9ca3af;
  padding: 24px;
}

.tasks-empty-icon { font-size: 36px; }
.tasks-empty-text { font-size: 13px; text-align: center; }

/* ‚îÄ‚îÄ Right: Action Grid ‚îÄ‚îÄ */
/* Right column wrapper ‚Äî flex column so banner + grid stack vertically */
.actions-col {
  flex: 1;
  min-width: 0;
  min-height: 0;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* AI-tag alert banner (full width of right column) */
.ai-banner {
  flex-shrink: 0;
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border: 1.5px solid #fde68a;
  border-radius: 12px;
  padding: 12px 16px;
  text-decoration: none;
  color: inherit;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.ai-banner:hover {
  border-color: #f59e0b;
  box-shadow: 0 2px 12px rgba(245,158,11,0.15);
}

.ai-banner-icon {
  font-size: 22px;
  flex-shrink: 0;
}

.ai-banner-body { flex: 1; min-width: 0; }

.ai-banner-title {
  font-size: 13px;
  font-weight: 700;
  color: #92400e;
}

.ai-banner-desc {
  font-size: 12px;
  color: #b45309;
  margin-top: 1px;
}

.ai-banner-count {
  background: #f59e0b;
  color: white;
  font-size: 13px;
  font-weight: 700;
  padding: 3px 11px;
  border-radius: 20px;
  flex-shrink: 0;
}

/* 2√ó2 action grid ‚Äî always 2 rows, no overflow */
.actions-grid {
  flex: 1;
  min-height: 0;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: 1fr 1fr;  /* exactly 2 equal rows, fills remaining height */
  gap: 14px;
}

/* Each action card */
.action-card {
  background: white;
  border-radius: 12px;
  border: 1px solid #f0f0f0;
  box-shadow: 0 1px 4px rgba(0,0,0,0.07);
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  text-decoration: none;
  color: inherit;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
  overflow: hidden;
}

.action-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  border-color: #e0e7ff;
}

.action-top {
  display: flex;
  align-items: center;
  gap: 10px;
}

.action-icon {
  width: 38px;
  height: 38px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}

.action-title {
  font-size: 14px;
  font-weight: 700;
  color: #111827;
}

.action-desc {
  font-size: 12px;
  color: #6b7280;
  line-height: 1.5;
  flex: 1;
}

.action-arrow {
  font-size: 12px;
  color: #9ca3af;
  align-self: flex-end;
}


/* Colour accents per card */
.icon-blue   { background: #eff6ff; }
.icon-green  { background: #f0fdf4; }
.icon-purple { background: #f5f3ff; }
.icon-orange { background: #fff7ed; }
.icon-amber  { background: #fffbeb; }

/* Progress bar (AI tag streaming) */
.progress-wrap {
  margin-top: 4px;
  display: none;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #fde68a;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 4px;
}

.progress-fill {
  height: 100%;
  background: #f59e0b;
  width: 0%;
  transition: width 0.3s;
}

.progress-text {
  font-size: 11px;
  color: #92400e;
}
</style>

<div class="db-page">

  <!-- ‚îÄ‚îÄ Top: Welcome bar ‚îÄ‚îÄ -->
  <div class="db-header">
    <div class="db-welcome">
      <div class="db-welcome-icon">üëã</div>
      <div class="db-welcome-text">
        <div class="db-welcome-name">{{ request.user.first_name|default:request.user.username }}</div>
        <div class="db-welcome-school">{{ school.name }}</div>
      </div>
    </div>

    <div class="db-stats">
      <div class="db-stat">
        <span class="db-stat-icon">üìã</span>
        <div>
          <div class="db-stat-val">{{ pending_tasks|length }}</div>
          <div class="db-stat-lbl">Pending tasks</div>
        </div>
      </div>
      {% if untagged_questions_count > 0 %}
      <div class="db-stat" style="border-color: #fde68a; background: #fffbeb;">
        <span class="db-stat-icon">üè∑Ô∏è</span>
        <div>
          <div class="db-stat-val" style="color: #b45309;">{{ untagged_questions_count }}</div>
          <div class="db-stat-lbl">Untagged Qs</div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Body ‚îÄ‚îÄ -->
  <div class="db-body">

    <!-- Left: Pending Tasks -->
    <div class="db-card">
      <div class="tasks-head">
        <span class="tasks-title">üìã Pending Tasks</span>
        {% if pending_tasks %}
          <span class="tasks-badge">{{ pending_tasks|length }}</span>
        {% else %}
          <span class="tasks-badge clear">‚úì Clear</span>
        {% endif %}
      </div>

      {% if pending_tasks %}
      <div class="tasks-scroll">
        {% for task in pending_tasks %}
        <div class="task-item" onclick="window.location.href='{{ task.url }}'"
             style="{% if task.type == 'grade_test' %}border-left: 3px solid #f59e0b;{% endif %}">
          <div class="task-icon">{{ task.icon }}</div>
          <div>
            <div class="task-title">{{ task.title }}</div>
            <div class="task-desc">{{ task.description }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="tasks-empty">
        <div class="tasks-empty-icon">‚ú®</div>
        <div class="tasks-empty-text">All caught up!<br>No pending tasks.</div>
      </div>
      {% endif %}
    </div>

    <!-- Right: banner + 2√ó2 card grid -->
    <div class="actions-col">

      {% if untagged_questions_count > 0 %}
      <!-- AI Tag ‚Äî compact full-width banner -->
      <a href="{% url 'untagged_questions' %}" class="ai-banner" id="bulkTagBtn">
        <span class="ai-banner-icon">ü§ñ</span>
        <div class="ai-banner-body">
          <div class="ai-banner-title">Untagged Questions</div>
          <div class="ai-banner-desc">Questions missing topic or learning objective tags ‚Äî use AI to tag them automatically.</div>
        </div>
        <span class="ai-banner-count">{{ untagged_questions_count }}</span>
        <div class="progress-wrap" id="progressWrap">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="progress-text" id="progressText">Processing‚Ä¶</div>
        </div>
      </a>
      {% endif %}

      <!-- 2√ó2 fixed grid -->
      <div class="actions-grid">

        <!-- Create Test -->
        <a href="{% url 'create_test' %}" class="action-card">
          <div class="action-top">
            <div class="action-icon icon-blue">üìù</div>
            <span class="action-title">Create Test</span>
          </div>
          <div class="action-desc">Build a new assessment from your question library or create questions inline.</div>
          <span class="action-arrow">‚Üí</span>
        </a>

        <!-- Question Library -->
        <a href="{% url 'question_library' %}" class="action-card">
          <div class="action-top">
            <div class="action-icon icon-green">üìö</div>
            <span class="action-title">Question Library</span>
          </div>
          <div class="action-desc">Browse, search, and manage all questions ‚Äî filter by grade, subject and topic.</div>
          <span class="action-arrow">‚Üí</span>
        </a>

        <!-- Manage Users -->
        <a href="{% url 'manage_users' %}" class="action-card">
          <div class="action-top">
            <div class="action-icon icon-purple">üë•</div>
            <span class="action-title">Manage Users</span>
          </div>
          <div class="action-desc">Create and manage teacher and student profiles for your school.</div>
          <span class="action-arrow">‚Üí</span>
        </a>

        <!-- Class Groups -->
        <a href="{% url 'manage_class_groups' %}" class="action-card">
          <div class="action-top">
            <div class="action-icon icon-orange">üéì</div>
            <span class="action-title">Class Groups</span>
          </div>
          <div class="action-desc">Organise students into cohort groups for easier test assignment and filtering.</div>
          <span class="action-arrow">‚Üí</span>
        </a>

      </div><!-- /actions-grid -->

    </div><!-- /actions-col -->

  </div><!-- /db-body -->

</div><!-- /db-page -->

<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

async function bulkAITag(e) {
  e.preventDefault();
  const btn          = document.getElementById('bulkTagBtn');
  const progressWrap = document.getElementById('progressWrap');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');

  if (!confirm('This will use AI to automatically tag all untagged questions with topics and learning objectives. This may take several minutes. Continue?')) return;

  btn.style.pointerEvents = 'none';
  btn.style.opacity = '0.8';
  progressWrap.style.display = 'block';

  try {
    const response = await fetch('/teacher/bulk-ai-tag/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }
    });

    const reader  = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      for (const line of decoder.decode(value).split('\n')) {
        if (!line.startsWith('data: ')) continue;
        try {
          const data = JSON.parse(line.substring(6));
          if (data.progress !== undefined) {
            progressFill.style.width = (data.progress / data.total * 100) + '%';
            progressText.textContent = `Tagged ${data.progress} of ${data.total} questions‚Ä¶`;
          }
          if (data.complete) {
            progressText.textContent = `‚úÖ Tagged ${data.total} questions!`;
            setTimeout(() => window.location.reload(), 2000);
          }
          if (data.error) {
            progressText.textContent = '‚ùå ' + data.error;
            btn.style.pointerEvents = '';
            btn.style.opacity = '';
          }
        } catch (_) {}
      }
    }
  } catch (err) {
    progressText.textContent = '‚ùå ' + err.message;
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
  }
}

const aiBtn = document.getElementById('bulkTagBtn');
if (aiBtn) aiBtn.addEventListener('click', bulkAITag);
</script>

{% endblock %}
